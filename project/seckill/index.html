<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>秒杀项目过程笔记 | DK&#39;s Notes</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/my-notes/img/logo.jpg">
    <link rel="stylesheet" href="/my-notes//at.alicdn.com/t/font_3334662_k54hl9700p.css">
    <link rel="stylesheet" href="/my-notes//at.alicdn.com/t/font_3334662_k54hl9700p.css">
    <link rel="stylesheet" href="/my-notes//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <link rel="stylesheet" href="/my-notes//at.alicdn.com/t/font_3334691_b03dsaqrwck.css">
    <meta name="description" content="时不我待，舍我其谁">
    <meta name="keywords" content="Java">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/my-notes/assets/css/0.styles.565c6041.css" as="style"><link rel="preload" href="/my-notes/assets/js/app.7f931ee0.js" as="script"><link rel="preload" href="/my-notes/assets/js/2.e52a17f8.js" as="script"><link rel="preload" href="/my-notes/assets/js/191.d75de9d3.js" as="script"><link rel="preload" href="/my-notes/assets/js/8.c2fa6f68.js" as="script"><link rel="preload" href="/my-notes/assets/js/6.bcc16901.js" as="script"><link rel="prefetch" href="/my-notes/assets/js/10.fee8f7ec.js"><link rel="prefetch" href="/my-notes/assets/js/100.9be19fac.js"><link rel="prefetch" href="/my-notes/assets/js/101.9aaae740.js"><link rel="prefetch" href="/my-notes/assets/js/102.a72c0165.js"><link rel="prefetch" href="/my-notes/assets/js/103.d47527c3.js"><link rel="prefetch" href="/my-notes/assets/js/104.d5bae560.js"><link rel="prefetch" href="/my-notes/assets/js/105.fdb07f67.js"><link rel="prefetch" href="/my-notes/assets/js/106.b89b7d37.js"><link rel="prefetch" href="/my-notes/assets/js/107.a9d142eb.js"><link rel="prefetch" href="/my-notes/assets/js/108.1b8c8817.js"><link rel="prefetch" href="/my-notes/assets/js/109.0cd465a0.js"><link rel="prefetch" href="/my-notes/assets/js/11.75b40e53.js"><link rel="prefetch" href="/my-notes/assets/js/110.4c56723c.js"><link rel="prefetch" href="/my-notes/assets/js/111.12b9cb85.js"><link rel="prefetch" href="/my-notes/assets/js/112.3f791546.js"><link rel="prefetch" href="/my-notes/assets/js/113.d9998b70.js"><link rel="prefetch" href="/my-notes/assets/js/114.faf0da70.js"><link rel="prefetch" href="/my-notes/assets/js/115.35d9b5f6.js"><link rel="prefetch" href="/my-notes/assets/js/116.13fbe1ab.js"><link rel="prefetch" href="/my-notes/assets/js/117.bffe4459.js"><link rel="prefetch" href="/my-notes/assets/js/118.eabefad3.js"><link rel="prefetch" href="/my-notes/assets/js/119.8593c8a5.js"><link rel="prefetch" href="/my-notes/assets/js/12.34db197a.js"><link rel="prefetch" href="/my-notes/assets/js/120.f5b73620.js"><link rel="prefetch" href="/my-notes/assets/js/121.d3137f51.js"><link rel="prefetch" href="/my-notes/assets/js/122.f47bca90.js"><link rel="prefetch" href="/my-notes/assets/js/123.6d846b88.js"><link rel="prefetch" href="/my-notes/assets/js/124.49825ebc.js"><link rel="prefetch" href="/my-notes/assets/js/125.6d3a9ce5.js"><link rel="prefetch" href="/my-notes/assets/js/126.eeef761b.js"><link rel="prefetch" href="/my-notes/assets/js/127.0f7e28c1.js"><link rel="prefetch" href="/my-notes/assets/js/128.4a35f42a.js"><link rel="prefetch" href="/my-notes/assets/js/129.e364bc33.js"><link rel="prefetch" href="/my-notes/assets/js/13.ab02aa59.js"><link rel="prefetch" href="/my-notes/assets/js/130.1299fc06.js"><link rel="prefetch" href="/my-notes/assets/js/131.61faa498.js"><link rel="prefetch" href="/my-notes/assets/js/132.9e46a3c4.js"><link rel="prefetch" href="/my-notes/assets/js/133.0b6e6f7f.js"><link rel="prefetch" href="/my-notes/assets/js/134.6724b7a7.js"><link rel="prefetch" href="/my-notes/assets/js/135.1d3daca0.js"><link rel="prefetch" href="/my-notes/assets/js/136.190f2a28.js"><link rel="prefetch" href="/my-notes/assets/js/137.5ce96397.js"><link rel="prefetch" href="/my-notes/assets/js/138.c0b55b02.js"><link rel="prefetch" href="/my-notes/assets/js/139.068ed7d7.js"><link rel="prefetch" href="/my-notes/assets/js/14.721e1994.js"><link rel="prefetch" href="/my-notes/assets/js/140.5226be4f.js"><link rel="prefetch" href="/my-notes/assets/js/141.196d1aa6.js"><link rel="prefetch" href="/my-notes/assets/js/142.11cbb52f.js"><link rel="prefetch" href="/my-notes/assets/js/143.509f8300.js"><link rel="prefetch" href="/my-notes/assets/js/144.436415bf.js"><link rel="prefetch" href="/my-notes/assets/js/145.a25cd8bc.js"><link rel="prefetch" href="/my-notes/assets/js/146.a2d1d780.js"><link rel="prefetch" href="/my-notes/assets/js/147.1cac4e0a.js"><link rel="prefetch" href="/my-notes/assets/js/148.5c361eba.js"><link rel="prefetch" href="/my-notes/assets/js/149.f62eacfa.js"><link rel="prefetch" href="/my-notes/assets/js/15.35ef567c.js"><link rel="prefetch" href="/my-notes/assets/js/150.80b0aa20.js"><link rel="prefetch" href="/my-notes/assets/js/151.6f0e31d8.js"><link rel="prefetch" href="/my-notes/assets/js/152.86efa86d.js"><link rel="prefetch" href="/my-notes/assets/js/153.d6605e26.js"><link rel="prefetch" href="/my-notes/assets/js/154.e5b33cc7.js"><link rel="prefetch" href="/my-notes/assets/js/155.5d3cf278.js"><link rel="prefetch" href="/my-notes/assets/js/156.bcb9784f.js"><link rel="prefetch" href="/my-notes/assets/js/157.ca3b8e8c.js"><link rel="prefetch" href="/my-notes/assets/js/158.eb0116b8.js"><link rel="prefetch" href="/my-notes/assets/js/159.309a26da.js"><link rel="prefetch" href="/my-notes/assets/js/16.ca698d39.js"><link rel="prefetch" href="/my-notes/assets/js/160.ce6e9321.js"><link rel="prefetch" href="/my-notes/assets/js/161.ac24f13a.js"><link rel="prefetch" href="/my-notes/assets/js/162.c3390211.js"><link rel="prefetch" href="/my-notes/assets/js/163.8267154f.js"><link rel="prefetch" href="/my-notes/assets/js/164.3ce822f9.js"><link rel="prefetch" href="/my-notes/assets/js/165.80836bd1.js"><link rel="prefetch" href="/my-notes/assets/js/166.7346e59a.js"><link rel="prefetch" href="/my-notes/assets/js/167.5577b6af.js"><link rel="prefetch" href="/my-notes/assets/js/168.23aca72c.js"><link rel="prefetch" href="/my-notes/assets/js/169.ce891665.js"><link rel="prefetch" href="/my-notes/assets/js/17.549cfc80.js"><link rel="prefetch" href="/my-notes/assets/js/170.b4aebdaf.js"><link rel="prefetch" href="/my-notes/assets/js/171.39cdd90b.js"><link rel="prefetch" href="/my-notes/assets/js/172.06cd5671.js"><link rel="prefetch" href="/my-notes/assets/js/173.44c7c161.js"><link rel="prefetch" href="/my-notes/assets/js/174.62d8a34f.js"><link rel="prefetch" href="/my-notes/assets/js/175.baa645ac.js"><link rel="prefetch" href="/my-notes/assets/js/176.8361f852.js"><link rel="prefetch" href="/my-notes/assets/js/177.4a8f2fec.js"><link rel="prefetch" href="/my-notes/assets/js/178.f594def6.js"><link rel="prefetch" href="/my-notes/assets/js/179.2338f129.js"><link rel="prefetch" href="/my-notes/assets/js/18.a8b4f826.js"><link rel="prefetch" href="/my-notes/assets/js/180.1b2f62df.js"><link rel="prefetch" href="/my-notes/assets/js/181.10759f41.js"><link rel="prefetch" href="/my-notes/assets/js/182.c0e1c3c5.js"><link rel="prefetch" href="/my-notes/assets/js/183.bdc8283f.js"><link rel="prefetch" href="/my-notes/assets/js/184.30a6f685.js"><link rel="prefetch" href="/my-notes/assets/js/185.1949079b.js"><link rel="prefetch" href="/my-notes/assets/js/186.bb7c7093.js"><link rel="prefetch" href="/my-notes/assets/js/187.1d02d132.js"><link rel="prefetch" href="/my-notes/assets/js/188.5230fbeb.js"><link rel="prefetch" href="/my-notes/assets/js/189.2931d469.js"><link rel="prefetch" href="/my-notes/assets/js/19.16e1a44c.js"><link rel="prefetch" href="/my-notes/assets/js/190.9bd3b616.js"><link rel="prefetch" href="/my-notes/assets/js/192.dacb160e.js"><link rel="prefetch" href="/my-notes/assets/js/193.660b4fce.js"><link rel="prefetch" href="/my-notes/assets/js/194.45f8499e.js"><link rel="prefetch" href="/my-notes/assets/js/195.e91d4663.js"><link rel="prefetch" href="/my-notes/assets/js/196.e94176ac.js"><link rel="prefetch" href="/my-notes/assets/js/197.5acbb43f.js"><link rel="prefetch" href="/my-notes/assets/js/198.dc1a1207.js"><link rel="prefetch" href="/my-notes/assets/js/199.288adcec.js"><link rel="prefetch" href="/my-notes/assets/js/20.b19ef4b2.js"><link rel="prefetch" href="/my-notes/assets/js/200.3d318d2e.js"><link rel="prefetch" href="/my-notes/assets/js/21.e3682738.js"><link rel="prefetch" href="/my-notes/assets/js/22.fafa8b54.js"><link rel="prefetch" href="/my-notes/assets/js/23.9d683b40.js"><link rel="prefetch" href="/my-notes/assets/js/24.02c0c08c.js"><link rel="prefetch" href="/my-notes/assets/js/25.af427f02.js"><link rel="prefetch" href="/my-notes/assets/js/26.50a41828.js"><link rel="prefetch" href="/my-notes/assets/js/27.8f1d2fe6.js"><link rel="prefetch" href="/my-notes/assets/js/28.7f820229.js"><link rel="prefetch" href="/my-notes/assets/js/29.208cdce3.js"><link rel="prefetch" href="/my-notes/assets/js/3.32ea0d41.js"><link rel="prefetch" href="/my-notes/assets/js/30.e7a171d3.js"><link rel="prefetch" href="/my-notes/assets/js/31.8ee9f363.js"><link rel="prefetch" href="/my-notes/assets/js/32.b33ae00e.js"><link rel="prefetch" href="/my-notes/assets/js/33.3a961845.js"><link rel="prefetch" href="/my-notes/assets/js/34.46f30eb6.js"><link rel="prefetch" href="/my-notes/assets/js/35.dedda1f7.js"><link rel="prefetch" href="/my-notes/assets/js/36.fb63ded5.js"><link rel="prefetch" href="/my-notes/assets/js/37.321340a9.js"><link rel="prefetch" href="/my-notes/assets/js/38.c21281dd.js"><link rel="prefetch" href="/my-notes/assets/js/39.01776b7e.js"><link rel="prefetch" href="/my-notes/assets/js/4.2466bf2a.js"><link rel="prefetch" href="/my-notes/assets/js/40.c6763f18.js"><link rel="prefetch" href="/my-notes/assets/js/41.afa4c2f3.js"><link rel="prefetch" href="/my-notes/assets/js/42.187357b5.js"><link rel="prefetch" href="/my-notes/assets/js/43.90030eae.js"><link rel="prefetch" href="/my-notes/assets/js/44.e11eff59.js"><link rel="prefetch" href="/my-notes/assets/js/45.760e3e3f.js"><link rel="prefetch" href="/my-notes/assets/js/46.0eccc1a4.js"><link rel="prefetch" href="/my-notes/assets/js/47.30e063f8.js"><link rel="prefetch" href="/my-notes/assets/js/48.5ab681d2.js"><link rel="prefetch" href="/my-notes/assets/js/49.5921c987.js"><link rel="prefetch" href="/my-notes/assets/js/5.56264475.js"><link rel="prefetch" href="/my-notes/assets/js/50.a53fa873.js"><link rel="prefetch" href="/my-notes/assets/js/51.5cded08c.js"><link rel="prefetch" href="/my-notes/assets/js/52.8960c473.js"><link rel="prefetch" href="/my-notes/assets/js/53.2ac21c0e.js"><link rel="prefetch" href="/my-notes/assets/js/54.361bc2f3.js"><link rel="prefetch" href="/my-notes/assets/js/55.3853b7f3.js"><link rel="prefetch" href="/my-notes/assets/js/56.754a3b4c.js"><link rel="prefetch" href="/my-notes/assets/js/57.1d9684e7.js"><link rel="prefetch" href="/my-notes/assets/js/58.0e7f2b60.js"><link rel="prefetch" href="/my-notes/assets/js/59.b37ab2f4.js"><link rel="prefetch" href="/my-notes/assets/js/60.f31d0aea.js"><link rel="prefetch" href="/my-notes/assets/js/61.5aebeb50.js"><link rel="prefetch" href="/my-notes/assets/js/62.cebf26d6.js"><link rel="prefetch" href="/my-notes/assets/js/63.6c7932ca.js"><link rel="prefetch" href="/my-notes/assets/js/64.cad8a013.js"><link rel="prefetch" href="/my-notes/assets/js/65.25e4c14e.js"><link rel="prefetch" href="/my-notes/assets/js/66.e9c81af6.js"><link rel="prefetch" href="/my-notes/assets/js/67.31cbef00.js"><link rel="prefetch" href="/my-notes/assets/js/68.edc93332.js"><link rel="prefetch" href="/my-notes/assets/js/69.5eaf1e4f.js"><link rel="prefetch" href="/my-notes/assets/js/7.5a6eeb6c.js"><link rel="prefetch" href="/my-notes/assets/js/70.7114cd64.js"><link rel="prefetch" href="/my-notes/assets/js/71.2066867c.js"><link rel="prefetch" href="/my-notes/assets/js/72.0f93cb73.js"><link rel="prefetch" href="/my-notes/assets/js/73.6c4d69ec.js"><link rel="prefetch" href="/my-notes/assets/js/74.0a91fc3c.js"><link rel="prefetch" href="/my-notes/assets/js/75.47e45f38.js"><link rel="prefetch" href="/my-notes/assets/js/76.99886a8d.js"><link rel="prefetch" href="/my-notes/assets/js/77.61eb4f51.js"><link rel="prefetch" href="/my-notes/assets/js/78.eff53df7.js"><link rel="prefetch" href="/my-notes/assets/js/79.e5d77573.js"><link rel="prefetch" href="/my-notes/assets/js/80.8ac4e931.js"><link rel="prefetch" href="/my-notes/assets/js/81.82416621.js"><link rel="prefetch" href="/my-notes/assets/js/82.b7cea701.js"><link rel="prefetch" href="/my-notes/assets/js/83.eb0065f7.js"><link rel="prefetch" href="/my-notes/assets/js/84.45596ac9.js"><link rel="prefetch" href="/my-notes/assets/js/85.73902eef.js"><link rel="prefetch" href="/my-notes/assets/js/86.05a157f2.js"><link rel="prefetch" href="/my-notes/assets/js/87.83218f21.js"><link rel="prefetch" href="/my-notes/assets/js/88.bf05ee49.js"><link rel="prefetch" href="/my-notes/assets/js/89.089b5c96.js"><link rel="prefetch" href="/my-notes/assets/js/9.4a5b4024.js"><link rel="prefetch" href="/my-notes/assets/js/90.dc0b55a6.js"><link rel="prefetch" href="/my-notes/assets/js/91.ddc7da4f.js"><link rel="prefetch" href="/my-notes/assets/js/92.2b5c7d5f.js"><link rel="prefetch" href="/my-notes/assets/js/93.934a02e9.js"><link rel="prefetch" href="/my-notes/assets/js/94.3a6ede23.js"><link rel="prefetch" href="/my-notes/assets/js/95.0e946220.js"><link rel="prefetch" href="/my-notes/assets/js/96.3861fb05.js"><link rel="prefetch" href="/my-notes/assets/js/97.8627cefa.js"><link rel="prefetch" href="/my-notes/assets/js/98.6e0ee750.js"><link rel="prefetch" href="/my-notes/assets/js/99.5df99b25.js">
    <link rel="stylesheet" href="/my-notes/assets/css/0.styles.565c6041.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-notes/" class="home-link router-link-active"><img src="/my-notes/img/logo.jpg" alt="DK's Notes" class="logo"> <span class="site-name can-hide">DK's Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-notes/" class="nav-link">首页</a></div><div class="nav-item"><a href="/my-notes/about/website/tools/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/my-notes/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java-Se</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/java/se/base/" class="nav-link">Java基础</a></li></ul></li><li class="dropdown-item"><h4>Java-Se进阶-多线程</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/java/se/thread/" class="nav-link">多线程</a></li></ul></li><li class="dropdown-item"><h4>Java-Se进阶-java8新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/java/se/java8/" class="nav-link">java8新特性</a></li></ul></li><li class="dropdown-item"><h4>Java-ee</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/javaweb/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java虚拟机</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/JVM/" class="nav-link">JVM</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/my-notes/mysql/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/mysql/" class="nav-link">MySQL</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/my-notes/es/" class="nav-link">ElasticSearch</a></li><li class="dropdown-subitem"><a href="/my-notes/mongodb/" class="nav-link">MongoDB</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/my-notes/mybatis/study-note/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>ORM</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/mybatis/study-note/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/my-notes/mybatis-plus/study-note/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>Spring</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/Spring/study-note/" class="nav-link">Spring</a></li></ul></li><li class="dropdown-item"><h4>SpringMVC</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/SpringMvc/study-note/1/" class="nav-link">SpringMVC1</a></li><li class="dropdown-subitem"><a href="/my-notes/SpringMvc/study-note/2/" class="nav-link">SpringMVC2</a></li></ul></li><li class="dropdown-item"><h4>SpringCloud</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/SpringCloud/" class="nav-link">SpringCloud</a></li></ul></li><li class="dropdown-item"><h4>中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/my-notes/dubbo/" class="nav-link">Dubbo</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><a href="/my-notes/project/seckill/" aria-current="page" class="link-title router-link-exact-active router-link-active">项目</a> <span class="title" style="display:none;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-notes/project/seckill/" aria-current="page" class="nav-link router-link-exact-active router-link-active">秒杀项目</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具|部署" class="dropdown-title"><a href="/my-notes/git/" class="link-title">工具|部署</a> <span class="title" style="display:none;">工具|部署</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-notes/git/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/my-notes/Linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/my-notes/Docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/my-notes/JWT/note/" class="nav-link">JWT</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试|刷题" class="dropdown-title"><a href="/my-notes/work/interview/" class="link-title">面试|刷题</a> <span class="title" style="display:none;">面试|刷题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-notes/work/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/my-notes/work/algorithm/" class="nav-link">刷题</a></li></ul></div></div><div class="nav-item"><a href="/my-notes/dev/question/" class="nav-link">开发问题😈</a></div><div class="nav-item"><a href="/my-notes/designPattern/" class="nav-link">设计模式</a></div><div class="nav-item"><a href="/my-notes/about/" class="nav-link">关于💕</a></div><div class="nav-item"><a href="/my-notes/archives/" class="nav-link">归档🕛</a></div> <a href="https://github.com/hnistzdk/my-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.jpg"> <div class="blogger-info"><h3>风</h3> <span>摸鱼</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/my-notes/" class="nav-link">首页</a></div><div class="nav-item"><a href="/my-notes/about/website/tools/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/my-notes/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java-Se</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/java/se/base/" class="nav-link">Java基础</a></li></ul></li><li class="dropdown-item"><h4>Java-Se进阶-多线程</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/java/se/thread/" class="nav-link">多线程</a></li></ul></li><li class="dropdown-item"><h4>Java-Se进阶-java8新特性</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/java/se/java8/" class="nav-link">java8新特性</a></li></ul></li><li class="dropdown-item"><h4>Java-ee</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/javaweb/" class="nav-link">JavaWeb</a></li></ul></li><li class="dropdown-item"><h4>Java虚拟机</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/JVM/" class="nav-link">JVM</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/my-notes/mysql/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/mysql/" class="nav-link">MySQL</a></li></ul></li><li class="dropdown-item"><h4>NoSQL 数据库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/my-notes/es/" class="nav-link">ElasticSearch</a></li><li class="dropdown-subitem"><a href="/my-notes/mongodb/" class="nav-link">MongoDB</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><a href="/my-notes/mybatis/study-note/" class="link-title">框架</a> <span class="title" style="display:none;">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>ORM</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/mybatis/study-note/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/my-notes/mybatis-plus/study-note/" class="nav-link">MyBatis-Plus</a></li></ul></li><li class="dropdown-item"><h4>Spring</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/Spring/study-note/" class="nav-link">Spring</a></li></ul></li><li class="dropdown-item"><h4>SpringMVC</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/SpringMvc/study-note/1/" class="nav-link">SpringMVC1</a></li><li class="dropdown-subitem"><a href="/my-notes/SpringMvc/study-note/2/" class="nav-link">SpringMVC2</a></li></ul></li><li class="dropdown-item"><h4>SpringCloud</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/SpringCloud/" class="nav-link">SpringCloud</a></li></ul></li><li class="dropdown-item"><h4>中间件</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/my-notes/rabbitmq/" class="nav-link">RabbitMQ</a></li><li class="dropdown-subitem"><a href="/my-notes/dubbo/" class="nav-link">Dubbo</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><a href="/my-notes/project/seckill/" aria-current="page" class="link-title router-link-exact-active router-link-active">项目</a> <span class="title" style="display:none;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-notes/project/seckill/" aria-current="page" class="nav-link router-link-exact-active router-link-active">秒杀项目</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具|部署" class="dropdown-title"><a href="/my-notes/git/" class="link-title">工具|部署</a> <span class="title" style="display:none;">工具|部署</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-notes/git/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/my-notes/Linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/my-notes/Docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/my-notes/JWT/note/" class="nav-link">JWT</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试|刷题" class="dropdown-title"><a href="/my-notes/work/interview/" class="link-title">面试|刷题</a> <span class="title" style="display:none;">面试|刷题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-notes/work/interview/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/my-notes/work/algorithm/" class="nav-link">刷题</a></li></ul></div></div><div class="nav-item"><a href="/my-notes/dev/question/" class="nav-link">开发问题😈</a></div><div class="nav-item"><a href="/my-notes/designPattern/" class="nav-link">设计模式</a></div><div class="nav-item"><a href="/my-notes/about/" class="nav-link">关于💕</a></div><div class="nav-item"><a href="/my-notes/archives/" class="nav-link">归档🕛</a></div> <a href="https://github.com/hnistzdk/my-notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>秒杀项目</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-notes/project/seckill/" aria-current="page" class="active sidebar-link">秒杀项目过程笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/my-notes/project/seckill/#java秒杀方案" class="sidebar-link">Java秒杀方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/my-notes/project/seckill/#_1、页面优化" class="sidebar-link">1、页面优化</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_1-1、缓存" class="sidebar-link">1.1、缓存</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_1-2、静态化分离" class="sidebar-link">1.2、静态化分离</a></li><li class="sidebar-sub-header level3"><a href="/my-notes/project/seckill/#_2、服务优化" class="sidebar-link">2、服务优化</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_2-1、rabbitmq消息队列" class="sidebar-link">2.1、RabbitMQ消息队列</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_2-2、接口优化" class="sidebar-link">2.2、接口优化</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#完整代码" class="sidebar-link">完整代码：</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_2-3、分布式锁" class="sidebar-link">2.3、分布式锁</a></li><li class="sidebar-sub-header level3"><a href="/my-notes/project/seckill/#_3、安全优化" class="sidebar-link">3、安全优化</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_3-1、隐藏秒杀地址" class="sidebar-link">3.1、隐藏秒杀地址</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_3-2、验证码" class="sidebar-link">3.2、验证码</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_3-3、接口限流" class="sidebar-link">3.3、接口限流</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#固定窗口法" class="sidebar-link">固定窗口法</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#缺点" class="sidebar-link">缺点</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#滑动窗口法" class="sidebar-link">滑动窗口法</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#缺点-2" class="sidebar-link">缺点</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#漏桶算法" class="sidebar-link">漏桶算法</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#缺点-3" class="sidebar-link">缺点</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#令牌桶算法" class="sidebar-link">令牌桶算法</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#分布式场景" class="sidebar-link">分布式场景</a></li><li class="sidebar-sub-header level3"><a href="/my-notes/project/seckill/#_4、分布式会话" class="sidebar-link">4、分布式会话</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_4-1、用户登录" class="sidebar-link">4.1、用户登录</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#登录逻辑" class="sidebar-link">登录逻辑</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#参数校验" class="sidebar-link">参数校验</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#参数校验的全局异常处理" class="sidebar-link">参数校验的全局异常处理</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_4-2、共享session" class="sidebar-link">4.2、共享Session</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#一些解决方案" class="sidebar-link">一些解决方案</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#spring-session实现分布式session" class="sidebar-link">Spring Session实现分布式Session</a></li><li class="sidebar-sub-header level5"><a href="/my-notes/project/seckill/#redis存储用户信息" class="sidebar-link">Redis存储用户信息</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_4-3、优化登录" class="sidebar-link">4.3、优化登录</a></li><li class="sidebar-sub-header level3"><a href="/my-notes/project/seckill/#_5、功能开发" class="sidebar-link">5、功能开发</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_5-1、商品列表" class="sidebar-link">5.1、商品列表</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_5-2、商品详情" class="sidebar-link">5.2、商品详情</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_5-3、秒杀" class="sidebar-link">5.3、秒杀</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_5-4、订单详情" class="sidebar-link">5.4、订单详情</a></li><li class="sidebar-sub-header level3"><a href="/my-notes/project/seckill/#_6、系统压测" class="sidebar-link">6、系统压测</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_6-1、jmeter入门" class="sidebar-link">6.1、JMeter入门</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_6-2、自定义变量" class="sidebar-link">6.2、自定义变量</a></li><li class="sidebar-sub-header level4"><a href="/my-notes/project/seckill/#_6-3、正式压测" class="sidebar-link">6.3、正式压测</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/my-notes/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/my-notes/categories/?category=%E9%A1%B9%E7%9B%AE" title="分类" data-v-06225672>项目</a></li><li data-v-06225672><a href="/my-notes/categories/?category=%E7%A7%92%E6%9D%80%E9%A1%B9%E7%9B%AE" title="分类" data-v-06225672>秒杀项目</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://www.zaiolos.top/" target="_blank" title="作者" class="beLink" data-v-06225672>zdk</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-05-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">秒杀项目过程笔记<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p><strong>Table of Contents</strong> <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="noopener noreferrer">DocToc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em></p> <ul><li><a href="#java%E7%A7%92%E6%9D%80%E6%96%B9%E6%A1%88">Java秒杀方案</a> <ul><li><a href="#1%E9%A1%B5%E9%9D%A2%E4%BC%98%E5%8C%96">1、页面优化</a> <ul><li><a href="#11%E7%BC%93%E5%AD%98">1.1、缓存</a></li> <li><a href="#12%E9%9D%99%E6%80%81%E5%8C%96%E5%88%86%E7%A6%BB">1.2、静态化分离</a></li></ul></li> <li><a href="#2%E6%9C%8D%E5%8A%A1%E4%BC%98%E5%8C%96">2、服务优化</a> <ul><li><a href="#21rabbitmq%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">2.1、RabbitMQ消息队列</a></li> <li><a href="#22%E6%8E%A5%E5%8F%A3%E4%BC%98%E5%8C%96">2.2、接口优化</a> <ul><li><a href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81">完整代码：</a></li></ul></li> <li><a href="#23%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">2.3、分布式锁</a></li></ul></li> <li><a href="#3%E5%AE%89%E5%85%A8%E4%BC%98%E5%8C%96">3、安全优化</a> <ul><li><a href="#31%E9%9A%90%E8%97%8F%E7%A7%92%E6%9D%80%E5%9C%B0%E5%9D%80">3.1、隐藏秒杀地址</a></li> <li><a href="#32%E9%AA%8C%E8%AF%81%E7%A0%81">3.2、验证码</a></li> <li><a href="#33%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81">3.3、接口限流</a> <ul><li><a href="#%E5%9B%BA%E5%AE%9A%E7%AA%97%E5%8F%A3%E6%B3%95">固定窗口法</a></li> <li><a href="#%E7%BC%BA%E7%82%B9">缺点</a></li> <li><a href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%B3%95">滑动窗口法</a></li> <li><a href="#%E7%BC%BA%E7%82%B9-1">缺点</a></li> <li><a href="#%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95">漏桶算法</a></li> <li><a href="#%E7%BC%BA%E7%82%B9-2">缺点</a></li> <li><a href="#%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95">令牌桶算法</a></li> <li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%9C%BA%E6%99%AF">分布式场景</a></li></ul></li></ul></li> <li><a href="#4%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D">4、分布式会话</a> <ul><li><a href="#41%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95">4.1、用户登录</a> <ul><li><a href="#%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91">登录逻辑</a></li> <li><a href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C">参数校验</a></li> <li><a href="#%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E7%9A%84%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">参数校验的全局异常处理</a></li></ul></li> <li><a href="#42%E5%85%B1%E4%BA%ABsession">4.2、共享Session</a> <ul><li><a href="#%E4%B8%80%E4%BA%9B%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">一些解决方案</a></li> <li><a href="#spring-session%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8Fsession">Spring Session实现分布式Session</a></li> <li><a href="#redis%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF">Redis存储用户信息</a></li></ul></li> <li><a href="#43%E4%BC%98%E5%8C%96%E7%99%BB%E5%BD%95">4.3、优化登录</a></li></ul></li> <li><a href="#5%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91">5、功能开发</a> <ul><li><a href="#51%E5%95%86%E5%93%81%E5%88%97%E8%A1%A8">5.1、商品列表</a></li> <li><a href="#52%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85">5.2、商品详情</a></li> <li><a href="#53%E7%A7%92%E6%9D%80">5.3、秒杀</a></li> <li><a href="#54%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85">5.4、订单详情</a></li></ul></li> <li><a href="#6%E7%B3%BB%E7%BB%9F%E5%8E%8B%E6%B5%8B">6、系统压测</a> <ul><li><a href="#61jmeter%E5%85%A5%E9%97%A8">6.1、JMeter入门</a></li> <li><a href="#62%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F">6.2、自定义变量</a></li> <li><a href="#63%E6%AD%A3%E5%BC%8F%E5%8E%8B%E6%B5%8B">6.3、正式压测</a></li></ul></li></ul></li></ul> <hr> <h2 id="java秒杀方案"><a href="#java秒杀方案" class="header-anchor">#</a> Java秒杀方案</h2> <h3 id="_1、页面优化"><a href="#_1、页面优化" class="header-anchor">#</a> 1、页面优化</h3> <h4 id="_1-1、缓存"><a href="#_1-1、缓存" class="header-anchor">#</a> 1.1、缓存</h4> <blockquote><p>使用redis存储渲染后的html的String，存入redis，过期时间60ms。</p> <p>访问时先判断redis中是否存在页面的缓存，如果存在，使用<code>ThymeleafViewResolver</code>进行解析，然后返回解析后的字符串。</p> <p>注意：这样返回需要加上<code>@ResponseBody</code>注解，否则会报错</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;商品页面&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/toList&quot;</span><span class="token punctuation">,</span>produces <span class="token operator">=</span> <span class="token string">&quot;text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toList</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//因为使用的了HandlerMethodArgumentResolver</span>
        <span class="token comment">//就能省略 方法参数获取cookie,再通过cookie找User,再转换的过程</span>
        <span class="token comment">//而直接将User作为入参进行判断即可</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> html <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;goodsList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取页面 如果不为空 直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOk</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取页面 如果为空 手动渲染 存入redis 再返回</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;goodsList&quot;</span><span class="token punctuation">,</span> goodsService<span class="token punctuation">.</span><span class="token function">findGoodsVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最后一个map的参数 作为要返回的属性  就是model的attribute</span>
        <span class="token class-name">WebContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebContext</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span><span class="token function">asMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//进行解析</span>
        html <span class="token operator">=</span> thymeleafViewResolver<span class="token punctuation">.</span><span class="token function">getTemplateEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">&quot;goodsList&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOk</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//存入redis</span>
            redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;goodsList&quot;</span><span class="token punctuation">,</span> html<span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>商品详情页面同理：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;商品详情页&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/toDetail&quot;</span><span class="token punctuation">,</span>produces <span class="token operator">=</span> <span class="token string">&quot;text/html;charset=utf-8&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toDetail</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span><span class="token class-name">User</span> user<span class="token punctuation">,</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果存在 直接返回</span>
        <span class="token class-name">String</span> html <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;goodsDetails:&quot;</span><span class="token operator">+</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOk</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//为空 渲染 缓存 返回</span>
        <span class="token class-name">GoodsVo</span> goodsVo <span class="token operator">=</span> goodsService<span class="token punctuation">.</span><span class="token function">findGoodsVoById</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> startDate <span class="token operator">=</span> goodsVo<span class="token punctuation">.</span><span class="token function">getStartDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> endDate <span class="token operator">=</span> goodsVo<span class="token punctuation">.</span><span class="token function">getEndDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> secKillStatus<span class="token punctuation">;</span>
        <span class="token comment">//秒杀倒计时秒数</span>
        <span class="token keyword">long</span> remainSeconds<span class="token punctuation">;</span>
        <span class="token comment">//秒杀持续时间</span>
        <span class="token keyword">long</span> seckillSeconds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//秒杀未开始</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>startDate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            secKillStatus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            remainSeconds <span class="token operator">=</span> <span class="token punctuation">(</span>startDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>endDate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//秒杀已结束</span>
            secKillStatus <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            remainSeconds <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//秒杀进行中</span>
            seckillSeconds <span class="token operator">=</span> <span class="token punctuation">(</span>endDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
            secKillStatus <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            remainSeconds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;seckillSeconds&quot;</span><span class="token punctuation">,</span> seckillSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;secKillStatus&quot;</span><span class="token punctuation">,</span> secKillStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;remainSeconds&quot;</span><span class="token punctuation">,</span> remainSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;goods&quot;</span><span class="token punctuation">,</span> goodsVo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WebContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebContext</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span><span class="token function">asMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        html <span class="token operator">=</span> thymeleafViewResolver<span class="token punctuation">.</span><span class="token function">getTemplateEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">&quot;goodsDetail&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOk</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;goodsDetails:&quot;</span><span class="token operator">+</span>goodsId<span class="token punctuation">,</span> html<span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">压测</p> <span class="badge tip" style="vertical-align:top;" data-v-d5affa18>在此配置下：8核8线程i7-9700的windows</span> <p>1000个线程 重复10次，测三次 相当于30000</p> <ul><li>优化前QPS：1835.9/sec</li> <li>页面缓存优化后QPS：4448.4/sec</li></ul> <p>有2.4倍的提升</p></div> <h4 id="_1-2、静态化分离"><a href="#_1-2、静态化分离" class="header-anchor">#</a> 1.2、静态化分离</h4> <blockquote><p>即把页面的静态部分写死，然后通过Ajax获取动态数据，然后通过jQuery显示</p></blockquote> <h3 id="_2、服务优化"><a href="#_2、服务优化" class="header-anchor">#</a> 2、服务优化</h3> <h4 id="_2-1、rabbitmq消息队列"><a href="#_2-1、rabbitmq消息队列" class="header-anchor">#</a> 2.1、RabbitMQ消息队列</h4> <h4 id="_2-2、接口优化"><a href="#_2-2、接口优化" class="header-anchor">#</a> 2.2、接口优化</h4> <ol><li><p><strong>redis判重复秒杀</strong></p> <blockquote><p>redis储存成功的秒杀订单，判断用户是否已秒杀成功过</p></blockquote></li> <li><p><strong>redis预减库存</strong></p> <blockquote><p>在Bean的属性加载完成后，将库存加载到redis中，秒杀时使用redis预减库存</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token comment">/** 实现 InitializingBean接口 重写方法
     * 在Bean属性注入后 将商品的库存加载到redis中
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GoodsVo</span><span class="token punctuation">&gt;</span></span> goodsVo <span class="token operator">=</span> goodsService<span class="token punctuation">.</span><span class="token function">findGoodsVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>goodsVo<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">GoodsVo</span> vo <span class="token operator">:</span> goodsVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods:&quot;</span><span class="token operator">+</span>vo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vo<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//内存标记  防止库存为0但大量请求仍去查询redis获取库存</span>
                <span class="token comment">//这里使用本地内存标记库存的是否为0</span>
                emptyStockMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code> 		<span class="token comment">//使用redis的原子decr操作进行预减库存</span>
        <span class="token class-name">Long</span> stock <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods:&quot;</span> <span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><strong>内存标记</strong></p> <blockquote><p>库存进行内存标记，防止库存为0时仍有大量请求访问redis</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//使用一个map，key为秒杀商品的id，value为true则表示库存为0</span>
<span class="token comment">//在进行预减库存的时候 如果减去后的库存&lt;0了，就把这个商品id对应的值改成true</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> emptyStockMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//进行秒杀前 先判断内存标记</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>emptyStockMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">REPEAT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//如果库存被减为负数了,把库存加回来 修改内存标记为true  返回库存不足</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stock<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    emptyStockMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisUtil<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods:&quot;</span> <span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">REPEAT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p><strong>RabbitMQ异步下单</strong></p> <blockquote><p>在同步的情况下，用于对商品秒杀时，会在同一时间有大量更新库存、插入订单的请求流量直接到达数据库进行操作，对数据库的压力是巨大的，所以我们可以通过RabbitMQ减轻数据库压力：<code>当用户秒杀成功后，生产者发送一条消息，加入到消息队列中，然后即可立马返回给用户抢购成功，发送的消息由监听此队列的消费者处理，可根据数据库性能设置prefetch最大处理消息数量来进一步优化</code>。实际上用户并不关心能马上看到自己的订单，只关心是否成功，对于生成订单、更新库存可以通过异步处理写入数据库，比起多线程同步修改数据库的操作，大大缓解了数据库的连接压力，最主要的好处就表现在数据库连接的减少</p> <ul><li>同步方式：大量请求快速占满数据库框架开启的数据库连接池，同时修改数据库，导致数据库读写性能骤减</li> <li>一条条消息以顺序的方式写入数据库，连接数几乎不变（当然，也取决于消息队列消费者的数量）</li></ul></blockquote></li></ol> <h5 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码：</h5> <p><code>controller接口:</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;秒杀接口&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/doSeckill2&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ApiResp</span> <span class="token function">doSeckill2</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">SESSION_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: 2022/5/18 优化2 内存标记防止库存为0仍访问redis</span>
        <span class="token comment">//通过内存标记减少对redis的访问 如果内存标记库存直接为0 返回错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyStockMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">REPEAT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//查redis判断该用户是否已秒杀成功过</span>
        <span class="token class-name">String</span> seckillOrder <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;seckillOrder:&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOk</span><span class="token punctuation">(</span>seckillOrder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">REPEAT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: 2022/5/18 优化2 redis预减库存</span>
        <span class="token comment">//进行预减库存</span>
        <span class="token class-name">Long</span> stock <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods:&quot;</span> <span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果库存被减为负数了,把库存加回来 修改内存标记  返回库存不足</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            emptyStockMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisUtil<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">&quot;seckillGoods:&quot;</span> <span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">REPEAT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: 2022/5/18 异步下单</span>
        <span class="token comment">//RabbitMQ异步下单</span>
        orderMessageProducer<span class="token punctuation">.</span><span class="token function">sendOderMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SeckillOderMessage</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回正在排队的结果0给用户</span>
        <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><code>service:</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ApiResp</span> <span class="token function">seckill</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">GoodsVo</span> goodsVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//一开始是先查一遍seckillGoods 然后更新时 set库存=seckillGoods.getStockCount-1;</span>

        <span class="token comment">//优化： 不查，扣库存使用stock_count = stock_count - 1并且判断当前stock_count&gt;0</span>
        <span class="token comment">//扣库存-1</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> seckillGoodsService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock_count = stock_count - 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;goods_id&quot;</span><span class="token punctuation">,</span> goodsVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock_count&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//下单</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setGoodsId</span><span class="token punctuation">(</span>goodsVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setDeliveryAddrId</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setGoodsName</span><span class="token punctuation">(</span>goodsVo<span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setGoodsCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setGoodsPrice</span><span class="token punctuation">(</span>goodsVo<span class="token punctuation">.</span><span class="token function">getSeckillPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setOrderChannel</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> insert <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SeckillOrder</span> seckillOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillOrder<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillOrder<span class="token punctuation">.</span><span class="token function">setGoodsId</span><span class="token punctuation">(</span>goodsVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> save <span class="token operator">=</span> seckillOrderService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>seckillOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insert<span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>save<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//秒杀订单存入redis 加速判断重复秒杀</span>
            redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;seckillOrder:&quot;</span><span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>goodsVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="_2-3、分布式锁"><a href="#_2-3、分布式锁" class="header-anchor">#</a> 2.3、分布式锁</h4> <blockquote><p>使用redis的setIfAbsent操作，可以设置分布式锁，这个锁在分布式环境下是唯一的，可以保证操作的原子性。</p> <ol><li><p>线程1先set成功锁，执行业务，此时线程2进来，在锁没有过期的情况下，线程2不能set成功，无法执行业务，就保证了原子性，等线程1执行完后，删除这个锁，线程2即可正常进行</p></li> <li><p>但是这也会出现一个问题，如果由于网络原因或者系统自己宕机等，线程1没有执行删除锁操作，那么后面的线程就无法获取到锁，造成了死锁。因此我们可以为锁设置一个过期时间，一般要大于线程执行业务的时间，哪怕出现了问题，没有删除锁，锁也会过期，不会影响后面的线程set锁。</p></li> <li><p><code>因为删除时根据key去删除的</code>，假设有以下情况：线程1 set的锁为5秒过期，但是它执行了7秒才执行完，此时它会执行一个删除操作，而由于此时已经是第7秒，属于线程2拿到锁了，线程1删除时相当于把线程2的锁释放了，然后如果持续这样，线程2释放线程3的锁，这些线程的任务在一定程度上存在并行执行，而我们想要的是一个线程执行完另一个线程才能接着执行，所以要对删除操作进行优化</p></li> <li><p>为了解决3的问题，我们将锁的value值设置为一个随机字符串，每次释放锁的时候，都去比较随机字符串是否一致，如果一致再去释放锁，否则不释放。而释放锁时要进行：<code>查锁获取value，比较value是否正确，释放锁</code>，这三个步骤，不具备原子性，所以最终，我们使用lua脚本来保证操作的原子性</p></li></ol></blockquote> <blockquote><p>在上一步接口优化中，对redis库存的扣减，其实是有问题的，<code>在减少的时候并没有去判断它的值是否还能减</code>。假设同一个用户来了10个请求线程同时到达这个位置,就会直接将redis库存减到0,而后来的线程还会继续减为负数,而原来我们的处理是,减完后,判一下库存是否小于0了,小于0则加回去,这样虽然能够解决问题,但在难以保证在极端情况下还能正确。我们减redis库存也需要先比较是否能减,然后再减,所以要保证这两步操作的原子性 使用lua脚本</p></blockquote> <p>lua脚本代码：</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">--如果传入的key存在 执行下面的操作  不存在返回-1</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'exists'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">--先获取库存数量</span>
    <span class="token keyword">local</span> stock <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">--如果库存大于0 则减库存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'incrby'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stock<span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token punctuation">;</span>
    <span class="token comment">--没库存 返回-1</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">end</span> <span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>执行的工具方法(RedisUtil中)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token comment">/**
     * 执行lua脚本
     * @param script
     * @param key
     * @param args
     * @return
     * @param &lt;T&gt;
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> script<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>完整代码修改：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;秒杀接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/doSeckill&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ApiResp</span> <span class="token function">doSeckill</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">SESSION_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: 2022/5/18 优化2 内存标记防止库存为0仍访问redis</span>
        <span class="token comment">//通过内存标记减少对redis的访问 如果内存标记库存直接为0 返回错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyStockMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">REPEAT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//查redis判断该用户是否已秒杀成功过</span>
        <span class="token class-name">String</span> seckillOrder <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;seckillOrder:&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOk</span><span class="token punctuation">(</span>seckillOrder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">REPEAT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: 2022/5/19 优化3 lua脚本预减库存 解决redis库存负数问题</span>
        <span class="token comment">//lua脚本进行预减库存</span>
        <span class="token class-name">Long</span> stock <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>stockLuaScript<span class="token punctuation">,</span> <span class="token string">&quot;seckillGoods:&quot;</span> <span class="token operator">+</span> goodsId<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token constant">EMPTY_LIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            emptyStockMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>goodsId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">REPEAT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// TODO: 2022/5/18 异步下单</span>
        <span class="token comment">//RabbitMQ异步下单</span>
        orderMessageProducer<span class="token punctuation">.</span><span class="token function">sendOderMessage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SeckillOderMessage</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回正在排队的结果0给用户</span>
        <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_3、安全优化"><a href="#_3、安全优化" class="header-anchor">#</a> 3、安全优化</h3> <h4 id="_3-1、隐藏秒杀地址"><a href="#_3-1、隐藏秒杀地址" class="header-anchor">#</a> 3.1、隐藏秒杀地址</h4> <blockquote><p>将秒杀接口包装一层，在点击秒杀的时候，会先发起一次获取秒杀地址的请求，通过比对验证码后，返回一串随机UUID字符md5加密的秒杀地址的标识</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createPath</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token class-name">Md5Util</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将秒杀地址的随机串存入redis</span>
        redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;seckillPath:&quot;</span><span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>goodsId<span class="token punctuation">,</span> str<span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">checkPath</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodsId<span class="token punctuation">,</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>goodsId<span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> redisPath <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;seckillPath:&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisPath <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> redisPath<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;获取秒杀地址&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/path&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">ApiResp</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">,</span><span class="token class-name">String</span> captcha<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">SESSION_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Boolean</span> checkCaptcha <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">checkCaptcha</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> goodsId<span class="token punctuation">,</span> captcha<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>checkCaptcha<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">ERROR_CAPTCHA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">createPath</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>秒杀时先检查传来的该用户的随机秒杀path与redis中是否相等</p> <p><img src="https://images.zaiolos.top/images/image-20220520162704218.png" alt="image-20220520162704218"></p></blockquote> <h4 id="_3-2、验证码"><a href="#_3-2、验证码" class="header-anchor">#</a> 3.2、验证码</h4> <blockquote><p>在点击秒杀之前，添加验证码校验，使用easy-captcha</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--验证码依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.whvcse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>easy-captcha<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.6.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></blockquote> <p>后端接口生成一个算术验证码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;获取验证码&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/captcha&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">captcha</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span><span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GlobalException</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">SESSION_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//设置请求头为输出图片的类型</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;image/jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Pargam&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;No-cache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Cache-Control&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;no-cache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setDateHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Expires&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//生成算术验证码</span>
        <span class="token class-name">ArithmeticCaptcha</span> captcha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArithmeticCaptcha</span><span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//验证码存入redis 设置5分钟失效</span>
        redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;captcha:&quot;</span><span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>goodsId<span class="token punctuation">,</span>captcha<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            captcha<span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;用户:{} 验证码生成失败&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>前端：</p> <blockquote><p>如果在秒杀进行中，则调一次刷新验证码方式，将验证码所在块改为显示，否则改为隐藏</p> <p><img src="https://images.zaiolos.top/images/image-20220520161821713.png" alt="image-20220520161821713"></p> <p><img src="https://images.zaiolos.top/images/image-20220520161843454.png" alt="image-20220520161843454"></p> <p>在获取秒杀路径时，将验证码传过去，后端与存在redis中的验证码比对</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">checkCaptcha</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">Long</span> goodsId<span class="token punctuation">,</span> <span class="token class-name">String</span> captcha<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>captcha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> redisCaptcha <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;captcha:&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> goodsId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> captcha<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisCaptcha<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></blockquote> <h4 id="_3-3、接口限流"><a href="#_3-3、接口限流" class="header-anchor">#</a> 3.3、接口限流</h4> <span class="badge tip" style="vertical-align:top;" data-v-d5affa18>高并发系统用于保护系统有三种利器：缓存、降级、限流</span> <blockquote><p>服务端限流的方案可以归纳为<strong>两窗两桶</strong>（固定窗口，滑动窗口，漏桶算法，令牌桶算法）</p></blockquote> <h5 id="固定窗口法"><a href="#固定窗口法" class="header-anchor">#</a> 固定窗口法</h5> <ul><li>固定时间周期划分时间为多个时间窗口，如：每10秒为一个时间窗口</li> <li>在每个时间窗口内，每有一个请求，计数器加一</li> <li>当计数器超过限制，丢弃本窗口之后的所有请求</li> <li>当下一时间窗口开始，重置计数器</li></ul> <h5 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h5> <ul><li><p>通过请求量为允许限制的两倍</p> <blockquote><p>假设限制1秒内最多通过10个请求，在第一个窗口的最后半秒内通过了10个请求，第二个窗口的前半秒内又通过了10个请求。这样看来就是在1秒内通过了20个请求</p></blockquote></li> <li><p>一旦流量进入速度有所波动，要么计数器会被提前计满，导致这个周期内剩下时间段的请求被<em>限制</em>。要么就是计数器计不满，导致资源无法充分利用</p></li></ul> <h5 id="滑动窗口法"><a href="#滑动窗口法" class="header-anchor">#</a> 滑动窗口法</h5> <ul><li>以当前时间为截止时间，往前取一定的时间作为时间窗口，比如：往前取 60s 的时间</li> <li>当有新的请求进入时，删除时间窗口之外的请求，对时间窗口之内的请求进行计数统计，若未超过限制，则进行放行操作；若超过限制，则拒绝本次服务</li></ul> <h5 id="缺点-2"><a href="#缺点-2" class="header-anchor">#</a> 缺点</h5> <blockquote><p>当时间区精度越高，占用的空间资源就越大</p></blockquote> <h5 id="漏桶算法"><a href="#漏桶算法" class="header-anchor">#</a> 漏桶算法</h5> <ul><li>将每个请求视为水滴加入漏桶进行存储</li> <li>漏桶以固定速率匀速出水（处理请求）</li> <li>若桶满则抛弃请求</li></ul> <h5 id="缺点-3"><a href="#缺点-3" class="header-anchor">#</a> 缺点</h5> <blockquote><p>不适合<code>突发请求场景</code>：当短时间内有大量的突发请求时，即便此时服务器没有任何负载，每个请求也都得在队列中等待一段时间才能被响应。</p></blockquote> <h5 id="令牌桶算法"><a href="#令牌桶算法" class="header-anchor">#</a> 令牌桶算法</h5> <ul><li>以恒定的速度往令牌桶中放入令牌</li> <li>当有请求过来则从令牌桶中获取令牌进行后续请求</li> <li>当获取令牌失败后则进行友好处理。</li></ul> <h5 id="分布式场景"><a href="#分布式场景" class="header-anchor">#</a> 分布式场景</h5> <ul><li>网关限流</li> <li>Nginx限流
<ul><li>基于IP地址和基于服务器的访问请求限流</li> <li>并发量（连接数）限流</li> <li>下行带宽速率限制</li></ul></li></ul> <h3 id="_4、分布式会话"><a href="#_4、分布式会话" class="header-anchor">#</a> 4、分布式会话</h3> <h4 id="_4-1、用户登录"><a href="#_4-1、用户登录" class="header-anchor">#</a> 4.1、用户登录</h4> <h5 id="登录逻辑"><a href="#登录逻辑" class="header-anchor">#</a> 登录逻辑</h5> <blockquote><p>系统是使用mobile作为id的，密码是经过了<code>MD5(MD5(pass明文+固定salt)+salt)</code>两次md5加密的；</p> <p>第一次是前端通过固定salt先对密码加密一次</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//salt</span>
<span class="token keyword">var</span> g_passsword_salt<span class="token operator">=</span><span class="token string">&quot;1a2b3c4d&quot;</span>

<span class="token keyword">let</span> inputPass <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> salt <span class="token operator">=</span> g_passsword_salt<span class="token punctuation">;</span>
<span class="token keyword">let</span> str <span class="token operator">=</span> salt<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> salt<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> inputPass <span class="token operator">+</span> salt<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> salt<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> password <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>第二次是后端再通过这个用户注册时生成的salt再对密码加密一次(注册没有写 逻辑是这样的)</p> <p>所以登录的时候，先通过手机号判断是否有这个用户，有的话再看他的密码与使用他的salt加密后的 输入密码  是否相等，不等则抛出对应GlobalException。</p> <p>验证成功以后，为这个用户生成一个形式为UUID的凭证ticket，并把它存入redis并设置过期时间，然后封装为一个cookie返回给前端</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code></code></pre> <div class="line-numbers-wrapper"></div></div><h5 id="参数校验"><a href="#参数校验" class="header-anchor">#</a> 参数校验</h5> <blockquote><p>为了避免写太多的StringUtils.xxx这种冗余代码，我们可以引入validation的包来处理。下面引入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--        validation组件--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-validation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></blockquote> <p><strong>方式1:使用组件自带的校验</strong></p> <ol><li><p>首先，如果要校验的参数是对象，则将<code>@Valid</code>加对象前面(如果是String、Integer这些，直接使用对应的<code>@NotNull</code>等注解即可)。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token comment">//这里注意，必须要在Controller的方法之中使用</span>
	<span class="token comment">//测试如果在service的方法中使用，不会生效</span>
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/doLogin&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">ApiResp</span> <span class="token function">toLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token class-name">LoginVo</span> loginVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;loginVo:{}&quot;</span><span class="token punctuation">,</span>loginVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">doLogin</span><span class="token punctuation">(</span>loginVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>在类的属性上加上对应的注解即可，还可以在注解中指定校验失败时的message</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginVo</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;手机号不能为空&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mobile<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;密码不能为空&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Length</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token comment">/**
     * 可以用Pattern正则对手机号进行验证，如果用了，在不满足时，会抛出BindException
     * 此时需要我们手动处理(使用@RestControllerAdvice)，否则前端就得不到具体的响应
     *
     * 当然 也可以自定义注解
     */</span>
    <span class="token annotation punctuation">@Pattern</span><span class="token punctuation">(</span>regexp <span class="token operator">=</span> <span class="token string">&quot;[1]([3-9])[0-9]{9}$&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li></ol> <p><strong>方式2:通过自定义注解实现自定义的校验</strong></p> <ol><li><p>参考<code>@NotNull</code>注解定义我们的手机号格式校验注解</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token constant">METHOD</span><span class="token punctuation">,</span><span class="token constant">FIELD</span><span class="token punctuation">,</span><span class="token constant">ANNOTATION_TYPE</span><span class="token punctuation">,</span><span class="token constant">CONSTRUCTOR</span><span class="token punctuation">,</span><span class="token constant">PARAMETER</span><span class="token punctuation">,</span><span class="token constant">TYPE_USE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token comment">//这里是指定由哪个类来具体进行校验</span>
<span class="token comment">//这个类需实现ConstraintValidator&lt;A extends Annotation,T&gt;接口并实现所有方法</span>
<span class="token annotation punctuation">@Constraint</span><span class="token punctuation">(</span>validatedBy <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">IsMobileValidator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">IsMobile</span> <span class="token punctuation">{</span>
    <span class="token comment">//标识这个属性是必填的</span>
    <span class="token keyword">boolean</span> <span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token comment">//默认错误信息</span>
    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;手机号码格式错误&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Payload</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>定义<code>ConstraintValidator&lt;A extends Annotation,T&gt;接口</code>实现类，实现它的两个方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IsMobileValidator</span> <span class="token keyword">implements</span> <span class="token class-name">ConstraintValidator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IsMobile</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">//具体的校验逻辑</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">ConstraintValidatorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果不是必填的 并且为空 直接返回true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>required <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果必填 或者非必填时它填了  就需要校验</span>
        <span class="token keyword">return</span> <span class="token class-name">ValidatorUtil</span><span class="token punctuation">.</span><span class="token function">isMobile</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//在这个方法实现对required的初始化</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">IsMobile</span> constraintAnnotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        required <span class="token operator">=</span> constraintAnnotation<span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>校验工具类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidatorUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Pattern</span> <span class="token constant">MOBILE_PATTEN</span> <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&quot;[1]([3-9])[0-9]{9}$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 手机号码校验
     * @param mobile
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isMobile</span><span class="token punctuation">(</span><span class="token class-name">String</span> mobile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> <span class="token constant">MOBILE_PATTEN</span><span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> matcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>在字段上加上自定义注解即可</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginVo</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;手机号不能为空&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@IsMobile</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mobile<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;密码不能为空&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Length</span><span class="token punctuation">(</span>min <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ol> <blockquote><p>这样我们就完成了参数的校验，但是我们会发现，此时虽然参数校验成功了，后端代码并没有往下执行了，但前端并任何提示，这其实是因为，参数校验不通过时，Validator抛出了<code>BindException</code>(大都是抛出它的子类<code>MethodArgumentNotValidException</code>)，而我们并没有对这个异常进行处理，所以前端没有获取到对应的响应信息，所以我们需要添加一个全局异常的处理类来进行处理</p></blockquote> <h5 id="参数校验的全局异常处理"><a href="#参数校验的全局异常处理" class="header-anchor">#</a> 参数校验的全局异常处理</h5> <ol><li><p>自定义全局异常类。一定要继承RuntimeException类，而不是Exception类，如果是Exception类的话，抛出异常是需要在方法上throws的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @author zdk
 * @date 2022/5/15 18:13
 * 全局异常类
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ApiRespEnum</span> apiRespEnum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>这里选择使用<code>@RestControllerAdvice</code>类型的全局异常处理类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestControllerAdvice</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalExceptionHandler</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ApiResp</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//处理自定义的异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">GlobalException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">GlobalException</span> exception <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">GlobalException</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getApiRespEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//处理使用的Validator组件的异常</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">BindException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BindException</span> bindException <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BindException</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
            <span class="token class-name">ApiResp</span> respBean <span class="token operator">=</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">BIND_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            respBean<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;参数校验异常：&quot;</span> <span class="token operator">+</span> bindException<span class="token punctuation">.</span><span class="token function">getBindingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> respBean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;异常信息:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ApiResp</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ApiRespEnum</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li></ol> <div class="custom-block tip"><p class="custom-block-title">总结</p></div> <h4 id="_4-2、共享session"><a href="#_4-2、共享session" class="header-anchor">#</a> 4.2、共享Session</h4> <h5 id="一些解决方案"><a href="#一些解决方案" class="header-anchor">#</a> 一些解决方案</h5> <ul><li>Session复制
<ul><li>优点
<ul><li>无需修改代码，只需要修改Tomcat配置</li></ul></li> <li>缺点
<ul><li>Session同步传输占用内网带宽</li> <li>多台Tomcat同步时，性能指数级下降</li> <li>Session占用内存，无法有效水平扩展</li></ul></li></ul></li> <li>前端存储
<ul><li>优点
<ul><li>不占用服务端内存</li></ul></li> <li>缺点
<ul><li>存在安全风险</li> <li>数据大小受cookie限制</li> <li>占用外网带宽</li></ul></li></ul></li> <li>Session粘滞(一致性Hash)
<ul><li>优点
<ul><li>无需修改代码</li> <li>服务端可以水平扩展</li></ul></li> <li>缺点
<ul><li>增加新机器，会重新Hash，导致重新登录</li> <li>应用重启，需要重新登录</li></ul></li></ul></li> <li>后端集中存储
<ul><li>优点
<ul><li>安全</li> <li>容易水平扩展</li></ul></li> <li>缺点
<ul><li>增加复杂度</li> <li>需要修改代码</li></ul></li></ul></li></ul> <h5 id="spring-session实现分布式session"><a href="#spring-session实现分布式session" class="header-anchor">#</a> Spring Session实现分布式Session</h5> <ol><li><p>添加依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--Spring Boot Redis --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--Spring的分布式session--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--对象池依赖  Redis的lettuce对象池可能会用到--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>配置redis</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#redis配置</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 211.69.238.77
    <span class="token key atrule">password</span><span class="token punctuation">:</span> 
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token comment">#连接超时时间</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10000ms
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token comment">#最大连接数 默认8</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span>
        <span class="token comment">#最大连接阻塞时间 默认-1</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> 1000ms
        <span class="token comment">#最大空闲连接，默认8</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">200</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>上面的步骤执行以后，<code>set到Session的值 会被自动加入到redis中</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user:&quot;</span><span class="token operator">+</span>ticket<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://images.zaiolos.top/images/image-20220516162347445.png" alt="image-20220516162347445"></p></li></ol> <h5 id="redis存储用户信息"><a href="#redis存储用户信息" class="header-anchor">#</a> Redis存储用户信息</h5> <p>直接根据生成的ticket存储即可</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>		<span class="token comment">//生成一个ticket 并设置过期时间</span>
        <span class="token class-name">String</span> ticket <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//存入redis</span>
        redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user:&quot;</span><span class="token operator">+</span>ticket<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">setCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token string">&quot;userTicket&quot;</span><span class="token punctuation">,</span> ticket<span class="token punctuation">,</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_4-3、优化登录"><a href="#_4-3、优化登录" class="header-anchor">#</a> 4.3、优化登录</h4> <blockquote><p>在优化前，我们在需要User信息的Controller方法中，都需要在方法入参上加入<code>@CookieValue(&quot;userTicket&quot;) ticket</code>，然后在方法代码中通过判断ticket是否存在来跳转，存在时还要通过它去redis获取用户信息，过于重复和繁琐，所以我们使用<code>HandlerMethodArgumentResolver</code>优化</p></blockquote> <ol><li><p>首先创建一个类，实现<code>HandlerMethodArgumentResolver</code>接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @author zdk
 * @date 2022/5/16 18:19
 * 对Controller中的方法中的  User类型的参数做统一判断
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserHandlerMethodArgumentResolver</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerMethodArgumentResolver</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 如果参数的类型是User 才交由resolveArgument方法处理
     * @param parameter
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supportsParameter</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> clazz <span class="token operator">==</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">resolveArgument</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> parameter<span class="token punctuation">,</span> <span class="token class-name">ModelAndViewContainer</span> mavContainer<span class="token punctuation">,</span> <span class="token class-name">NativeWebRequest</span> webRequest<span class="token punctuation">,</span> <span class="token class-name">WebDataBinderFactory</span> binderFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> webRequest<span class="token punctuation">.</span><span class="token function">getNativeRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userTicket <span class="token operator">=</span> <span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">getCookieValue</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">&quot;userTicket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>userTicket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUserByCookie</span><span class="token punctuation">(</span>userTicket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><blockquote><p>这里面就通过cookie去获取了User对象，所以我们在Controller的方法参数上只需要写一个<code>User user</code>，然后在代码中对它判断一次即可</p></blockquote></li> <li><p>还要进行MVC的配置，添加MVC配置类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @author zdk
 * @date 2022/5/16 18:09
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserHandlerMethodArgumentResolver</span> userHandlerMethodArgumentResolver<span class="token punctuation">;</span>
	
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addArgumentResolvers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerMethodArgumentResolver</span><span class="token punctuation">&gt;</span></span> resolvers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//User类型的入参判断</span>
        resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userHandlerMethodArgumentResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>在方法中直接填入User参数即可</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/toList&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toList</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//因为使用的了HandlerMethodArgumentResolver</span>
        <span class="token comment">//就能省略 方法参数获取cookie,再通过cookie找User,再转换的过程</span>
        <span class="token comment">//而直接将User作为入参进行判断即可</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;goodsList&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ol> <h3 id="_5、功能开发"><a href="#_5、功能开发" class="header-anchor">#</a> 5、功能开发</h3> <h4 id="_5-1、商品列表"><a href="#_5-1、商品列表" class="header-anchor">#</a> 5.1、商品列表</h4> <blockquote><p>简单的显示秒杀商品的列表，显示图片、原价、秒杀价、秒杀库存数量</p></blockquote> <h4 id="_5-2、商品详情"><a href="#_5-2、商品详情" class="header-anchor">#</a> 5.2、商品详情</h4> <blockquote><p>主要是显示秒杀商品的开始时间、开始前的倒计时(秒)、正在秒杀状态、时间结束后的秒杀结束状态</p></blockquote> <div class="custom-block tip"><p class="custom-block-title">思路</p> <p>后端提供两个信息：秒杀状态和秒杀开始倒计时</p> <ol><li>秒杀商品表含有秒杀开始时间和结束时间，在后端查出秒杀商品信息后，用当前时间与秒杀开始时间和结束时间作对比</li> <li>如果当前时间在<code>秒杀开始时间之前</code>，则为秒杀未开始状态，需要计算倒计时并渲染到前端</li> <li>如果在<code>秒杀结束时间</code>之后，则为秒杀已结束状态，将按钮变更为不可点击</li> <li>如果在两者之间，证明秒杀正在进行，这里前端其实还需要对 <code>秒杀结束时间-当前时间</code>进行倒计时，倒计时结束后显示秒杀已结束，然后变更按钮状态，但教程中并未实现，只能通过刷新一次才能变成秒杀已结束状态。试着实现了一下，前端太拉了，没成功</li></ol></div> <h4 id="_5-3、秒杀"><a href="#_5-3、秒杀" class="header-anchor">#</a> 5.3、秒杀</h4> <div class="custom-block tip"><p class="custom-block-title">简略版</p> <p>用户一下单，查数据库判断库存，不足则返回错误；再判断是否重复秒杀(看秒杀订单里是否该用户已秒杀了该商品)，如果重复，返回错误；然后正常下单，下单时，扣库存、新增普通订单和秒杀订单数据</p></div> <div class="custom-block tip"><p class="custom-block-title">简单优化</p> <p>进入秒杀service中后，通过<code>一开始不查商品,直接扣库存,扣库存使用stock_count = stock_count - 1并且判断当前stock_count&gt;0</code>来扣库存、订单插入增加user_id和goods_id的唯一索引防止超卖(仅在单体中不超卖，分布式系统这种方式不能解决超卖问题)，同时在判断是否重复秒杀时，将秒杀订单存在redis，避免查数据库，提高速度</p></div> <h4 id="_5-4、订单详情"><a href="#_5-4、订单详情" class="header-anchor">#</a> 5.4、订单详情</h4> <h3 id="_6、系统压测"><a href="#_6、系统压测" class="header-anchor">#</a> 6、系统压测</h3> <h4 id="_6-1、jmeter入门"><a href="#_6-1、jmeter入门" class="header-anchor">#</a> 6.1、JMeter入门</h4> <p>修改jmeter.properties：添加<code>language=zh_CN、sampleresult.default.encoding=UTF-8</code>这两个属性</p> <div class="custom-block tip"><p class="custom-block-title">一些概念</p> <ul><li><p><strong>QPS</strong>：(<code>Queries Per Second</code>) 是每秒查询率，是一台服务器每秒能够响应的查询次数，是对一个特定的查询服务器<strong>在规定时间内</strong>所处理的流量多少的衡量标准，即每秒的响应请求数，也即是最大<a href="https://so.csdn.net/so/search?q=%E5%90%9E%E5%90%90%E9%87%8F&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">吞吐量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></li> <li><p><strong>TPS</strong> (<code>Transactions Per Second</code>) 也就是事务数/秒。一个事物是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数</p></li> <li><p><strong>QPS和TPS区别</strong>：TPS即每秒处理事务数，包括了<code>用户请求服务器</code>、<code>服务器自己的内部处理</code>、<code>服务器返回给用户</code>这三个过程，每秒能够完成N个这一组过程，TPS就是N；QPS基本类似于TPS，但是不同的是，<code>对于一个页面的一次访问，形成一个TPS</code>；<code>但一次页面请求，可能产生多次对服务器的请求，服务器对这些请求，就可计入&quot;QPS&quot;之中</code></p></li> <li><p><strong>并发数</strong>(并发度)：指系统同时能处理的请求数量，同时反应了系统的负载能力。这个数值可以分析机器1S内的访问日志数量来得到</p></li> <li><p><strong>吞吐量</strong>：吞吐量是指系统在单位时间内处理请求的数量，TPS、QPS都是吞吐量的常用量化指标。</p> <ul><li><p><strong>系统吞吐量要素</strong>：一个系统的吞吐量（承压能力）与request(请求)对cpu的消耗，外部接口，IO等等紧密关联。</p> <p>单个request对cpu消耗越高，外部系统接口，IO影响速度越慢，系统吞吐能力越低，反之越高</p></li> <li><p><strong>重要参数</strong>：QPS、TPS、并发数、响应时间</p></li></ul></li> <li><p><strong>关系</strong>：QPS(TPS)=并发数/平均响应时间</p></li></ul></div> <h4 id="_6-2、自定义变量"><a href="#_6-2、自定义变量" class="header-anchor">#</a> 6.2、自定义变量</h4> <h4 id="_6-3、正式压测"><a href="#_6-3、正式压测" class="header-anchor">#</a> 6.3、正式压测</h4></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/hnistzdk/my-notes/edit/master/docs/09.项目/01.秒杀项目/01.秒杀项目过程笔记.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">2022/10/04, 8:10:00</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:369365576@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/hnistzdk" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/hnistzdk" title="GitHub" target="_blank" class="iconfont icon-gitee"></a><a href="http://music.163.com/playlist?id=936642760&amp;userid=604011130" title="普通歌单" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2023
    <span>zdk | notes <br><a href=http://beian.miit.gov.cn/>湘ICP备2022001117号-1</a><br><img src=/img/ghs.png /><a href=http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51142102511562>川公网安备 51142102511562号</a><br><a href=https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referra><img src=/img/upyun.png align=absmiddle width=70px height=30px /></a> <span> 提供加速服务 </span></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div id="goTop" class="hide-cat" data-v-bf92849a></div><div></div><div></div></div></div>
    <script src="/my-notes/assets/js/app.7f931ee0.js" defer></script><script src="/my-notes/assets/js/2.e52a17f8.js" defer></script><script src="/my-notes/assets/js/191.d75de9d3.js" defer></script><script src="/my-notes/assets/js/8.c2fa6f68.js" defer></script><script src="/my-notes/assets/js/6.bcc16901.js" defer></script>
  </body>
</html>
