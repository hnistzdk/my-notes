---
title: Dubbo
date: 2022-05-28 19:19:06
permalink: /dubbo/Dubbo
categories:
  - 框架
  - Dubbo
tags:
  - Dubbo
---

## 必要的安装

### 1、安装Zookeeper

1. [腾讯微云安装包下载链接](https://share.weiyun.com/KTTzGeKK)

2. 上传到Linux，使用下面的命令压解

   ```shell
   tar -xzvf xxx
   ```

   

3. > 进入到压解目录的conf目录下，添加配置文件zoo.cfg

   ```
   # The number of milliseconds of each tick
   tickTime=2000
   # The number of ticks that the initial 
   # synchronization phase can take
   initLimit=10
   # The number of ticks that can pass between 
   # sending a request and getting an acknowledgement
   syncLimit=5
   # the directory where the snapshot is stored.
   # do not use /tmp for storage, /tmp here is just 
   # example sakes.
   dataDir=/usr/local/src/zookeeper/data
   # the port at which the clients will connect
   clientPort=2181
   # the maximum number of client connections.
   # increase this if you need to handle more clients
   #maxClientCnxns=60
   #
   # Be sure to read the maintenance section of the 
   # administrator guide before turning on autopurge.
   #
   # http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance
   #
   # The number of snapshots to retain in dataDir
   #autopurge.snapRetainCount=3
   # Purge task interval in hours
   # Set to "0" to disable auto purge feature
   #autopurge.purgeInterval=1
   
   ## Metrics Providers
   #
   # https://prometheus.io Metrics Exporter
   #metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
   #metricsProvider.httpPort=7000
   #metricsProvider.exportJvmInfo=true
   ```

4. 进入/bin目录，启动server

   ```shell
   bash zkServer.sh start #启动
   
   bash zkServer.sh status #查看状态
   
   bash zkServer.sh stop #停止
   ```

5. 可以通过zkCli连接server

   ```shell
   bash zkCli.sh -server localhost:2181
   #连接成功之后，通过键入help命令，查看客户端所支持的所有命令。（只要输入任何zkCli不能识别的内容，都会出现所有命令）
   ```



### 2、安装maven

```shell
--进入opt安装目录
[root@hadoop1 /]# cd opt/

--解压maven安装包
[root@hadoop1 opt]# tar -zxvf apache-maven-3.8.5-bin.tar.gz

--将文件移动到/usr/local/maven目录下,注:linux安装软件大多都安装在usr/local目录下
[root@hadoop1 opt]# mv apache-maven-3.8.5 /usr/local/maven

--配置maven系统环境变量文件,注：添加在末尾即可
[root@hadoop1 /]# vim /etc/profile
# maven config
export M2_HOME=/usr/local/maven
export PATH=$PATH:$M2_HOME/bin

--刷新环境变量: 使用source /etc/profile编译后只能在当前终端生效
[root@hadoop1 /]# source /etc/profile

--验证maven是否安装成功，注：返回版本信息表示maven安装成功
[root@hadoop1 /]# mvn -version
Apache Maven 3.8.5 (3599d3414f046de2324203b78ddcf9b5e4388aa0)
Maven home: /usr/local/maven
Java version: 1.8.0_161, vendor: Oracle Corporation, runtime: /usr/java/jre
Default locale: zh_CN, platform encoding: UTF-8
OS name: "linux", version: "2.6.32-642.el6.x86_64", arch: "amd64", family: "unix"
```

配一下镜像

```xml
<mirrors>
	<!--阿里云公共仓库是central仓和jcenter仓的聚合仓-->
    <mirror>
		<id>aliyunmaven</id>
		<mirrorOf>*</mirrorOf>
		<name>阿里云公共仓库</name>
		<url>https://maven.aliyun.com/repository/public</url>
	</mirror>
	<mirror>
		<id>aliyunmaven</id>
		<mirrorOf>*</mirrorOf>
		<name>阿里云谷歌仓库</name>
		<url>https://maven.aliyun.com/repository/google</url>
	</mirror>
	<mirror>
		<id>aliyunmaven</id>
		<mirrorOf>*</mirrorOf>
		<name>阿里云阿帕奇仓库</name>
		<url>https://maven.aliyun.com/repository/apache-snapshots</url>
	</mirror>
	<mirror>
		<id>aliyunmaven</id>
		<mirrorOf>*</mirrorOf>
		<name>阿里云spring仓库</name>
		<url>https://maven.aliyun.com/repository/spring</url>
	</mirror>
	<mirror>
		<id>aliyunmaven</id>
		<mirrorOf>*</mirrorOf>
		<name>阿里云spring插件仓库</name>
		<url>https://maven.aliyun.com/repository/spring-plugin</url>
	</mirror>
	<mirror>
		<id>maven</id>
		<mirrorOf>*</mirrorOf>
		<name>maven仓库</name>
		<url>https://mvnrepository.com/</url>
	</mirror>
</mirrors>
```



### 3、安装运行Dubbo-admin

下载这个jar包 运行即可

[腾讯微云](https://share.weiyun.com/DlqKvptc)



## demo

### 创建工程(三个模块)

#### 父工程

pom:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.0.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>

    <groupId>com.zdk</groupId>
    <artifactId>dubbo-study</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>
    <modules>
        <module>boot-user-service-provider</module>
        <module>boot-user-service-consumer</module>
        <module>api-commons</module>
    </modules>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>2.3.0.RELEASE</version>
            </dependency>
            <!--zookeeper客户端-->
            <dependency>
                <groupId>com.github.sgroschupf</groupId>
                <artifactId>zkclient</artifactId>
                <version>0.1</version>
                <exclusions>
                    <exclusion>
                        <groupId>org.apache.zookeeper</groupId>
                        <artifactId>zookeeper</artifactId>
                    </exclusion>
                </exclusions>
            </dependency>
            <!--dubbo自定义启动器-->
            <dependency>
                <groupId>org.apache.dubbo</groupId>
                <artifactId>dubbo-spring-boot-starter</artifactId>
                <version>2.7.8</version>
            </dependency>
            <!--curator提供zookeeper连接-->
            <dependency>
                <groupId>org.apache.curator</groupId>
                <artifactId>curator-framework</artifactId>
                <version>2.12.0</version>
            </dependency>
            <dependency>
                <groupId>org.apache.curator</groupId>
                <artifactId>curator-recipes</artifactId>
                <version>2.12.0</version>
            </dependency>

        </dependencies>
    </dependencyManagement>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```



#### 一个provider

pom:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>dubbo-study</artifactId>
        <groupId>com.zdk</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>boot-user-service-provider</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>

    <dependencies>
        <dependency>
            <groupId>com.zdk</groupId>
            <artifactId>api-commons</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!--zookeeper客户端-->
        <dependency>
            <groupId>com.github.sgroschupf</groupId>
            <artifactId>zkclient</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>org.apache.zookeeper</groupId>
                    <artifactId>zookeeper</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <!--dubbo自定义启动器-->
        <dependency>
            <groupId>org.apache.dubbo</groupId>
            <artifactId>dubbo-spring-boot-starter</artifactId>
        </dependency>
        <!--curator提供zookeeper连接-->
        <dependency>
            <groupId>org.apache.curator</groupId>
            <artifactId>curator-framework</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.curator</groupId>
            <artifactId>curator-recipes</artifactId>
        </dependency>

    </dependencies>
</project>
```





#### 一个consumer

pom:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>dubbo-study</artifactId>
        <groupId>com.zdk</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>boot-user-service-consumer</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
    <dependencies>
        <dependency>
            <groupId>com.zdk</groupId>
            <artifactId>api-commons</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>


        <!--zookeeper客户端-->
        <dependency>
            <groupId>com.github.sgroschupf</groupId>
            <artifactId>zkclient</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>org.apache.zookeeper</groupId>
                    <artifactId>zookeeper</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <!--dubbo自定义启动器-->
        <dependency>
            <groupId>org.apache.dubbo</groupId>
            <artifactId>dubbo-spring-boot-starter</artifactId>
        </dependency>
        <!--curator提供zookeeper连接-->
        <dependency>
            <groupId>org.apache.curator</groupId>
            <artifactId>curator-framework</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.curator</groupId>
            <artifactId>curator-recipes</artifactId>
        </dependency>
    </dependencies>
</project>
```

#### 一个api-common

> 不需要依赖，就存储共用的bean或者interface等



::: tip 步骤

1. 将服务提供者注册到注册中心(zookeeper)

   ```yaml
   spring:
     application:
       name: userServiceProvider
   dubbo:
     application:
       name: userServiceProvider
     scan:
       base-packages: com.zdk.service
     registry:
       address: zookeeper://211.69.238.105:2181
       client: curator
       timeout: 10000
     config-center:
       timeout: 10000
   server:
     port: 8991
   ```

   然后将接口暴露出来

   ```java
   @Service//这个是spring的注解
   @DubboService//这个注解将接口暴露
   public class UserServiceImpl implements UserService {
       @Override
       public List<UserAddress> userList() {
           List<UserAddress> users = new ArrayList<>();
           users.add(new UserAddress(1, "zdk1", "123", "张迪凯1","asdsad","sadsad"));
           users.add(new UserAddress(2, "zdk2", "123", "张迪凯2","asdsad","sadsad"));
           return users;
       }
   }
   ```

2. 让服务消费者去注册中心定于服务提供者的服务地址

   ```yaml
   spring:
     application:
       name: userServiceConsumer
   dubbo:
     application:
       name: userServiceConsumer
     registry:
       address: zookeeper://211.69.238.105:2181
   server:
     port: 8992
   ```

   然后在需要UserService的地方对它进行引用

   ```java
   @Service
   public class OrderServiceImpl implements OrderService {
       @DubboReference//此注解就是引用provider暴露的接口实现
       private UserService userService;
   
       @Override
       public List<UserAddress> initOrder(String userID) {
           //查询用户的收货地址
           return userService.userList();
       }
   }
   ```

3. 测试结果

   ```java
   @RestController
   public class OrderController {
   
       @Autowired
       private OrderService orderService;
   
       @GetMapping("/initOrder")
       public List<UserAddress> initOrder(@RequestParam("uid") String userId){
           return orderService.initOrder(userId);
       }
   }
   ```

   ![image-20220529134944664](https://images.zaiolos.top/images/image-20220529134944664.png)

:::



## 一些配置

### 方法调用超时时间

> 服务提供者可以使用暴露服务的注解中的参数methods，然后使用@Method注解来指定该指定的方法的调用超时时间，超时即报错
>
> ```java
> @DubboService(methods = {@Method(name = "userList",timeout = 2000)})
> public class UserServiceImpl implements UserService {
>     @Override
>     public List<UserAddress> userList() {
> 		//xxx
>     }
> }
> ```

> 同样，消费者也可指定，同时指定时，以消费者优先
>
> ```java
> @DubboReference(methods = {@Method(name = "userList", timeout = 2000)})
> private UserService userService;
> ```

::: tip 总的配置原则

1. 精确优先(方法级优先，接口次之，全局配置再次之)
2. 消费者设置优先(如果级别一样，则消费方优先，提供方次之)

:::



### 重试次数

> 服务调用失败后的重试次数，消费者设置如下(服务提供者类似)
>
> ```java
> @DubboReference(methods = {
>             @Method(name = "userList", 
>                     timeout = 2000,
>                     retries = 2
>             )
>     })
> ```

> 配置后发起了两次重试

![image-20220529142942212](https://images.zaiolos.top/images/image-20220529142942212.png)



> 一般只在幂等的方法上设置重试次数，非幂等性的方法不重试



### 多版本

> 我们可以提供对同一个服务的不同实现版本

```java
//指定原实现类版本为1.0.0
@Service
@DubboService(methods = {@Method(name = "userList",timeout = 2000)},version = "1.0.0")
public class UserServiceImpl implements UserService {//xxx}
```

新增一个实现类，指定版本为1.0.1

```java
@Service
@DubboService(methods = {@Method(name = "userList",timeout = 2000)},version = "1.0.1")
public class UserServiceImpl2 implements UserService {
    @Override
    public List<UserAddress> userList() {
        System.out.println("进入服务接口版本2..");
        List<UserAddress> users = new ArrayList<>();
        users.add(new UserAddress(1, "zdk1", "123", "张迪凯1","asdsad","sadsad"));
        users.add(new UserAddress(2, "zdk2", "123", "张迪凯2","asdsad","sadsad"));
//        try {
//            TimeUnit.SECONDS.sleep(3);
//        } catch (InterruptedException e) {
//            throw new RuntimeException(e);
//        }
        return users;
    }
}
```

在消费者引用时，指定引用的版本

```java
@Service
public class OrderServiceImpl implements OrderService {
    @DubboReference(methods = {
            @Method(name = "userList",
                    timeout = 2000,
                    retries = 2
            )
    },check = false,version = "1.0.1")//指定使用1.0.1版本
    private UserService userService;

    @Override
    public List<UserAddress> initOrder(String userID) {
        //查询用户的收货地址
        return userService.userList();
    }
}
```

测试结果：

![image-20220529144447044](https://images.zaiolos.top/images/image-20220529144447044.png)



### 使用JavaConfig方式配置Dubbo服务

在provider项目中添加如下配置类

```java
package com.zdk.config;

import com.zdk.service.OrderService;
import com.zdk.service.UserService;
import org.apache.dubbo.config.*;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.ArrayList;
import java.util.List;

/**
 * @author zdk
 * @date 2022/5/29 15:13
 */
@Configuration
public class DubboConfig {

    /**
     * 注入应用配置
     * @param registryConfig 注册中心
     * @return
     */
    @Bean
    public ApplicationConfig applicationConfig(RegistryConfig registryConfig){
        //配置服务的名字
        ApplicationConfig applicationConfig = new ApplicationConfig("userServiceProvider");
        //配置注册中心
        applicationConfig.setRegistry(registryConfig);
        return applicationConfig;
    }

    /**
     * 注册一个 注册中心配置的Bean
     * @return
     */
    @Bean
    public RegistryConfig registryConfig(){
        RegistryConfig registryConfig = new RegistryConfig();
        registryConfig.setPort(2181);
        registryConfig.setAddress("211.69.238.105");
        registryConfig.setProtocol("zookeeper");
        return registryConfig;
    }

    /**
     * 配置通信协议 比如协议使用dubbo协议 20880端口
     * @return
     */
    @Bean
    public ProtocolConfig protocolConfig(){
        ProtocolConfig protocolConfig = new ProtocolConfig();
        protocolConfig.setName("dubbo");
        protocolConfig.setPort(20880);
        return protocolConfig;
    }

    /**
     * 配置提供的服务
     * @param userService
     * @return
     */
    @Bean
    public ServiceConfig<UserService> serviceConfigBase(@Qualifier("userServiceImpl") UserService userService){
        ServiceConfig<UserService> serviceConfig = new ServiceConfig<>();
        //配置服务接口
        serviceConfig.setInterface(UserService.class);
        //配置和这个接口的实现
        serviceConfig.setRef(userService);
        //配置接口的版本
        serviceConfig.setVersion("1.0.0");

        //配置每个方法的信息
        MethodConfig methodConfig = new MethodConfig();
        methodConfig.setName("userList");
        methodConfig.setTimeout(2000);

        //将方法关联到ServiceConfig中
        List<MethodConfig> methodConfigList = new ArrayList<>();
        serviceConfig.setMethods(methodConfigList);

        //还可以配置ProviderConfig、MonitorConfig等等

        return serviceConfig;
    }
}
```

> 配置了这些以后yaml里面的除了server:port之外后可以注释掉，测试效果一样。注意上面注册的版本，我注册的1.0.1，然后consumer调用1.0.0，是调用不到的，出现no aviable provider错误





## 高可用

### 1、zookeeper宕机与dubbo直联

现象：zookeeper注册中心宕机，还可以消费dubbo暴露的服务



::: tip 原因

健壮性

- 监控中心宕掉不影响使用，只是丢失部分采样数据
- 数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务
- 注册中心对等集群，任意一台宕掉后，将自动切换到另一台
- **注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通讯**
- 服务提供者无状态，任意一台宕掉后，不影响使用
- 服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复

:::

<Badge text="高可用：通过设计，减少系统不能提供服务的时间；"/>



> 通过 `@DubboReference(url = "127.0.0.1:20880")`方式可以使用dubbo直联



### 2、集群下dubbo负载均衡配置

> 在集群负载均衡时，Dubbo 提供了多种均衡策略，缺省为 random，即随机调用。

#### Random LoadBalance(随机)

> 随机，按权重设置随机概率。
>
> 在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。

#### RoundRobin LoadBalance(轮询)

> 轮循，按公约后的权重设置轮循比率。
>
> 存在慢的提供者累积请求的问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。

##### 测试

> 我们分三个端口启动三个provider，各自的service输出对应的 System.out.println("进入服务接口..xxx");
>
> 然后启动消费者进行访问测试



#### LeastActive LoadBalance

> 最少活跃调用数，相同活跃数的随机，活跃数指调用前后计数差。`简单来说就是响应速度越快的提供者会收到更多的请求，反之亦然`
>
> 使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大。

#### ConsistentHash LoadBalance

> **一致性 Hash，相同参数的请求总是发到同一提供者。**
>
> 当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。算法参见：http://en.wikipedia.org/wiki/Consistent_hashing
>
> 缺省只对第一个参数 Hash，如果要修改，请配置 <dubbo:parameter key="hash.arguments" value="0,1" />
>
> 缺省用 160 份虚拟节点，如果要修改，请配置 <dubbo:parameter key="hash.nodes" value="320" />

