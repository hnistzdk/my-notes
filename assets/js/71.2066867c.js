(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{419:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("ul",[t("li",[t("a",{attrs:{href:"#%E7%AE%80%E4%BB%8B"}},[s._v("简介")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#myisam-%E8%A1%A8%E9%94%81"}},[s._v("MyISAM 表锁")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#%E5%A6%82%E4%BD%95%E5%8A%A0%E8%A1%A8%E9%94%81"}},[s._v("如何加表锁")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E8%AF%BB%E9%94%81%E6%A1%88%E4%BE%8B"}},[s._v("读锁案例")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#%E6%80%BB%E7%BB%93"}},[s._v("总结")])])])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E5%86%99%E9%94%81%E6%A1%88%E4%BE%8B"}},[s._v("写锁案例")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#%E6%80%BB%E7%BB%93-1"}},[s._v("总结")])])])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E7%BB%93%E8%AE%BA"}},[s._v("结论")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E6%9F%A5%E7%9C%8B%E9%94%81%E7%9A%84%E4%BA%89%E7%94%A8%E6%83%85%E5%86%B5%E5%93%AA%E4%BA%9B%E8%A1%A8%E8%A2%AB%E5%8A%A0%E9%94%81%E4%BA%86"}},[s._v("查看锁的争用情况(哪些表被加锁了)")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E8%A1%A8%E9%94%81%E5%AE%9A"}},[s._v("如何分析表锁定")])])])]),s._v(" "),t("li",[t("a",{attrs:{href:"#innodb-%E8%A1%8C%E9%94%81"}},[s._v("InnoDB 行锁")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"#%E8%A1%8C%E9%94%81%E4%BB%8B%E7%BB%8D"}},[s._v("行锁介绍")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"}},[s._v("背景知识")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#innodb-%E7%9A%84%E8%A1%8C%E9%94%81%E6%A8%A1%E5%BC%8F"}},[s._v("InnoDB 的行锁模式")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E8%A1%8C%E9%94%81%E5%9F%BA%E6%9C%AC%E6%BC%94%E7%A4%BA"}},[s._v("行锁基本演示")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E6%97%A0%E7%B4%A2%E5%BC%95%E8%A1%8C%E9%94%81%E5%8D%87%E7%BA%A7%E4%B8%BA%E8%A1%A8%E9%94%81"}},[s._v("无索引行锁升级为表锁")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E9%97%B4%E9%9A%99%E9%94%81%E5%8D%B1%E5%AE%B3"}},[s._v("间隙锁危害")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#innodb-%E8%A1%8C%E9%94%81%E4%BA%89%E7%94%A8%E6%83%85%E5%86%B5"}},[s._v("InnoDB 行锁争用情况")])]),s._v(" "),t("li",[t("a",{attrs:{href:"#%E6%80%BB%E7%BB%93-2"}},[s._v("总结")])])])])]),s._v(" "),t("h2",{attrs:{id:"简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("锁概述")])])]),s._v(" "),t("p",[s._v("锁是计算机协调多个进程或线程并发访问某一资源的机制（避免争抢）。")]),s._v(" "),t("p",[s._v("在数据库中，除传统的计算资源（如 CPU、RAM、I/O 等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("锁分类：")])])]),s._v(" "),t("p",[s._v("从对数据操作的粒度分 ：")]),s._v(" "),t("p",[s._v("1） 表锁：操作时，会锁定整个表。")]),s._v(" "),t("p",[s._v("2） 行锁：操作时，会锁定当前操作行。")]),s._v(" "),t("p",[s._v("从对数据操作的类型分：")]),s._v(" "),t("p",[s._v("1） 读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响。")]),s._v(" "),t("p",[s._v("2） 写锁（排它锁）：当前操作没有完成之前，它会阻断其他写锁和读锁。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("Mysql 锁")])])]),s._v(" "),t("p",[s._v("相对其他数据库而言，MySQL的锁机制比较简单，其最显著的特点是不同的存储引擎支持不同的锁机制。")]),s._v(" "),t("p",[s._v("下表中罗列出了各存储引擎对锁的支持情况：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("存储引擎")]),s._v(" "),t("th",[s._v("表级锁")]),s._v(" "),t("th",[s._v("行级锁")]),s._v(" "),t("th",[s._v("页面锁")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("MyISAM")]),s._v(" "),t("td",[s._v("支持")]),s._v(" "),t("td",[s._v("不支持")]),s._v(" "),t("td",[s._v("不支持")])]),s._v(" "),t("tr",[t("td",[s._v("InnoDB")]),s._v(" "),t("td",[s._v("支持")]),s._v(" "),t("td",[s._v("支持")]),s._v(" "),t("td",[s._v("不支持")])]),s._v(" "),t("tr",[t("td",[s._v("MEMORY")]),s._v(" "),t("td",[s._v("支持")]),s._v(" "),t("td",[s._v("不支持")]),s._v(" "),t("td",[s._v("不支持")])]),s._v(" "),t("tr",[t("td",[s._v("BDB")]),s._v(" "),t("td",[s._v("支持")]),s._v(" "),t("td",[s._v("不支持")]),s._v(" "),t("td",[s._v("支持")])])])]),s._v(" "),t("p",[s._v("MySQL这3种锁的特性可大致归纳如下 ：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("锁类型")]),s._v(" "),t("th",[s._v("特点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("表级锁")]),s._v(" "),t("td",[s._v("偏向MyISAM 存储引擎，开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高,并发度最低。")])]),s._v(" "),t("tr",[t("td",[s._v("行级锁")]),s._v(" "),t("td",[s._v("偏向InnoDB 存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低,并发度也最高。")])]),s._v(" "),t("tr",[t("td",[s._v("页面锁")]),s._v(" "),t("td",[s._v("开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。")])])])]),s._v(" "),t("p",[s._v("从上述特点可见，很难笼统地说哪种锁更好，只能就具体应用的特点来说哪种锁更合适！仅从锁的角度来说：表级锁更适合于以查询为主，只有少量按索引条件更新数据的应用，如Web 应用；而行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并查询的应用，如一些在线事务处理（OLTP）系统。")]),s._v(" "),t("h2",{attrs:{id:"myisam-表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#myisam-表锁"}},[s._v("#")]),s._v(" MyISAM 表锁")]),s._v(" "),t("p",[s._v("MyISAM 存储引擎只支持表锁，这也是MySQL开始几个版本中唯一支持的锁类型。")]),s._v(" "),t("h3",{attrs:{id:"如何加表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何加表锁"}},[s._v("#")]),s._v(" 如何加表锁")]),s._v(" "),t("p",[s._v("MyISAM 在执行查询语句（SELECT）前，会自动给涉及的所有表加读锁，在执行更新操作（UPDATE、DELETE、INSERT 等）前，会自动给涉及的表加写锁，这个过程并不需要用户干预，因此，用户一般不需要直接用 LOCK TABLE 命令给 MyISAM 表显式加锁。")]),s._v(" "),t("div",{staticClass:"language-SQL line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" table_name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--加读锁")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" table_name writ"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--加写锁")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"读锁案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#读锁案例"}},[s._v("#")]),s._v(" 读锁案例")]),s._v(" "),t("p",[s._v("准备环境")]),s._v(" "),t("div",{staticClass:"language-SQL line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("database")]),s._v(" demo_03 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("charset")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8mb4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" demo_03"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tb_book"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("auto_increment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARCHAR")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("publish_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHAR")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("myisam "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARSET")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" tb_book "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" publish_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'java编程思想'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2088-08-01'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" tb_book "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" publish_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'solr编程思想'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2088-08-08'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tb_user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("auto_increment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARCHAR")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("myisam "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARSET")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" tb_user "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'令狐冲'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" tb_user "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'田伯光'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("p",[s._v("客户端 一 ：")]),s._v(" "),t("p",[s._v("1）加 tb_book 表的读锁")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tb_book "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("2） 执行查询操作")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tb_book"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856123.png",alt:"1553906896564"}})]),s._v(" "),t("p",[s._v("可以正常执行 ， 查询出数据。")]),s._v(" "),t("p",[s._v("客户端 二 ：")]),s._v(" "),t("p",[s._v("3） 执行查询操作")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tb_book"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856514.png",alt:"1553907044500"}})]),s._v(" "),t("p",[s._v("客户端 一 ：")]),s._v(" "),t("p",[s._v("4）查询未锁定的表")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tb_seller"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856220.png",alt:"1553908913515"}})]),s._v(" "),t("p",[s._v("客户端 二 ：")]),s._v(" "),t("p",[s._v("5）查询未锁定的表")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tb_seller"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856147.png",alt:"1553908973840"}})]),s._v(" "),t("p",[s._v("可以正常查询出未锁定的表；")]),s._v(" "),t("p",[s._v("客户端 一 ：")]),s._v(" "),t("p",[s._v("6） 执行插入操作")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" tb_book "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Mysql高级'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2088-01-01'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856085.png",alt:"1553907198462"}})]),s._v(" "),t("p",[s._v("执行插入， 直接报错 ， 由于当前tb_book 获得的是 读锁， 不能执行更新操作。")]),s._v(" "),t("p",[s._v("客户端 二 ：")]),s._v(" "),t("p",[s._v("7） 执行插入操作")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" tb_book "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Mysql高级'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2088-01-01'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856599.png",alt:"1553907403957"}})]),s._v(" "),t("p",[s._v("当在客户端一中释放锁指令 unlock tables  后 ， 客户端二中的 inesrt 语句 ， 立即执行 ；")]),s._v(" "),t("h4",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("blockquote",[t("p",[s._v("场景：session1给表A加了"),t("code",[s._v("读锁")]),s._v("，session2未做任何动作")]),s._v(" "),t("p",[s._v("产生的影响：")]),s._v(" "),t("ul",[t("li",[s._v("session1"),t("code",[s._v("可以读表A，但不可以读其他表")]),s._v("。且"),t("code",[s._v("不可以对表A或其他表进行增删改操作")]),s._v("(因为是读锁)")]),s._v(" "),t("li",[s._v("session2"),t("code",[s._v("可以读表A，也可以读其他表，也可以增删改其他未锁定的表")]),s._v("，但"),t("code",[s._v("对表A进行增删改操作的时候，会陷入阻塞，直到session1释放对表A的读锁为止")])])])]),s._v(" "),t("h3",{attrs:{id:"写锁案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#写锁案例"}},[s._v("#")]),s._v(" 写锁案例")]),s._v(" "),t("p",[s._v("客户端 一 :")]),s._v(" "),t("p",[s._v("1）给 tb_book 表的写锁")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" tb_book "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("write")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("2）执行查询操作")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tb_book "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856172.png",alt:"1553907849829"}})]),s._v(" "),t("p",[s._v("查询操作执行成功；")]),s._v(" "),t("p",[s._v("3）执行更新操作")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" tb_book "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'java编程思想（第二版）'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856883.png",alt:"1553907875221"}})]),s._v(" "),t("p",[s._v("更新操作执行成功 ；")]),s._v(" "),t("p",[s._v("客户端 二 :")]),s._v(" "),t("p",[s._v("4）执行查询操作")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("select * from tb_book ;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856095.png",alt:"1553908019755"}})]),s._v(" "),t("p",[s._v("当在客户端一中释放锁指令 unlock tables  后 ， 客户端二中的 select 语句 ， 立即执行 ；")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856689.png",alt:"1553908131373"}})]),s._v(" "),t("h4",{attrs:{id:"总结-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结-2"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("blockquote",[t("p",[s._v("场景：session1给表A加了"),t("code",[s._v("写锁")]),s._v("，session2未做任何动作")]),s._v(" "),t("p",[s._v("产生的影响：")]),s._v(" "),t("ul",[t("li",[s._v("此时session1对表A的增删改查操作都可以正常执行，而session2对表A的所有操作都会受到阻塞，知道session1释放锁")])]),s._v(" "),t("p",[t("code",[s._v("注：session2第二次查询时可能不会被阻塞是因为第二次是从mysql的缓存中取得的数据")])])]),s._v(" "),t("h3",{attrs:{id:"结论"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),t("p",[s._v("锁模式的相互兼容性如表中所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856768.png",alt:"1553905621992"}})]),s._v(" "),t("p",[s._v("由上表可见：")]),s._v(" "),t("p",[s._v("​\t1） 对MyISAM 表的读操作，不会阻塞其他用户对同一表的读请求，但会阻塞对同一表的写请求；")]),s._v(" "),t("p",[s._v("​\t2） 对MyISAM 表的写操作，会都阻塞其他用户对同一表的读和写操作；")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("简而言之，就是读锁会阻塞写，但是不会阻塞读。而写锁，则既会阻塞读，又会阻塞写。")])])]),s._v(" "),t("blockquote",[t("p",[s._v("此外，MyISAM 的读写锁调度是写优先，这也是MyISAM不适合做写为主的表的存储引擎的原因。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞。")])]),s._v(" "),t("h3",{attrs:{id:"查看锁的争用情况-哪些表被加锁了"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看锁的争用情况-哪些表被加锁了"}},[s._v("#")]),s._v(" 查看锁的争用情况(哪些表被加锁了)")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("open")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),s._v("；\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856637.png",alt:"1556443073322"}})]),s._v(" "),t("p",[s._v("In_user : 表当前被查询使用的次数。如果该数为零，则表是打开的，但是当前没有被使用。")]),s._v(" "),t("p",[s._v("Name_locked：表名称是否被锁定。名称锁定用于取消表或对表进行重命名等操作。")]),s._v(" "),t("h3",{attrs:{id:"如何分析表锁定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何分析表锁定"}},[s._v("#")]),s._v(" 如何分析表锁定")]),s._v(" "),t("p",[t("code",[s._v("可以通过检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定")])]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'table%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856738.png",alt:"1556443170082"}})]),s._v(" "),t("p",[t("code",[s._v("Table_locks_immediate")]),s._v(" ： 指的是能够立即获得表级锁的次数，每立即获取锁，值加1。")]),s._v(" "),t("p",[t("code",[s._v("Table_locks_waited")]),s._v(" ： 指的是不能立即获取表级锁而需要等待的次数，每等待一次，该值加1，此值高说明存在着较为严重的表级锁争用情况。")]),s._v(" "),t("h2",{attrs:{id:"innodb-行锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#innodb-行锁"}},[s._v("#")]),s._v(" InnoDB 行锁")]),s._v(" "),t("h3",{attrs:{id:"行锁介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#行锁介绍"}},[s._v("#")]),s._v(" 行锁介绍")]),s._v(" "),t("blockquote",[t("p",[s._v("行锁特点 ：偏向InnoDB 存储引擎，开销大，加锁慢；会出现死锁；锁定力度最小，发生锁冲突的概率最低，并发度也最高。")]),s._v(" "),t("p",[s._v("InnoDB 与 MyISAM 的最大不同有两点：一是支持事务；二是采用了行级锁。")])]),s._v(" "),t("h3",{attrs:{id:"背景知识"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景知识"}},[s._v("#")]),s._v(" 背景知识")]),s._v(" "),t("p",[t("strong",[s._v("事务及其ACID属性")])]),s._v(" "),t("p",[s._v("事务是由一组SQL语句组成的逻辑处理单元。")]),s._v(" "),t("p",[s._v("事务具有以下4个特性，简称为事务ACID属性。")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("ACID属性")]),s._v(" "),t("th",[s._v("含义")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("原子性（Atomicity）")]),s._v(" "),t("td",[s._v("事务是一个原子操作单元，其对数据的修改，要么全部成功，要么全部失败。")])]),s._v(" "),t("tr",[t("td",[s._v("一致性（Consistent）")]),s._v(" "),t("td",[s._v("在事务开始和完成时，数据都必须保持一致状态。")])]),s._v(" "),t("tr",[t("td",[s._v("隔离性（Isolation）")]),s._v(" "),t("td",[s._v("数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的 “独立” 环境下运行。")])]),s._v(" "),t("tr",[t("td",[s._v("持久性（Durable）")]),s._v(" "),t("td",[s._v("事务完成之后，对于数据的修改是永久的。")])])])]),s._v(" "),t("p",[t("strong",[s._v("并发事务处理带来的问题")])]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("问题")]),s._v(" "),t("th",[s._v("含义")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("丢失更新（Lost Update）")]),s._v(" "),t("td",[s._v("当两个或多个事务选择同一行，最初的事务修改的值，会被后面的事务修改的值覆盖。")])]),s._v(" "),t("tr",[t("td",[s._v("不可重复读（Non-Repeatable Reads）")]),s._v(" "),t("td",[s._v("在对于数据库中的某行记录，一个事务范围内多次查询却返回了不同的数据值，这是由于在查询间隔，另一个事务修改了数据并提交了。("),t("code",[s._v("事务A读到了事务B已经提交的修改数据")]),s._v(")")])]),s._v(" "),t("tr",[t("td",[s._v("脏读（Dirty Reads）")]),s._v(" "),t("td",[s._v("一个事务在执行过程中读取了另一个未提交的事务中的数据")])]),s._v(" "),t("tr",[t("td",[s._v("幻读（Phantom Reads）")]),s._v(" "),t("td",[s._v("一个事务按照相同的查询条件重新读取以前查询过的数据，却发现其他事务插入了满足其查询条件的新数据。("),t("code",[s._v("事务A读到了事务B提交的新增数据")]),s._v(")")])])])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("不可重复读和脏读的区别")]),s._v("是，脏读是某一事务读取了另一个事务未提交的脏数据，而不可重复读则是读取了前一事务已提交的数据。")])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("幻读和不可重复读")]),s._v("都是读取了另一条已经提交的事务，不同的是不可重复读的重点是修改，幻读的重点在于新增或者删除。")])]),s._v(" "),t("p",[t("strong",[s._v("事务隔离级别")])]),s._v(" "),t("p",[s._v("为了解决上述提到的事务并发问题，数据库提供一定的事务隔离机制来解决这个问题。")]),s._v(" "),t("p",[t("mark",[s._v("数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使用事务在一定程度上“串行化” 进行，这显然与“并发” 是矛盾的。 ")])]),s._v(" "),t("p",[s._v("数据库的隔离级别有4个，由低到高依次为 Read uncommitted、Read committed、Repeatable read、Serializable，这四个级别可以逐个解决 脏写、脏读、不可重复读、幻读 这几类问题。")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("隔离级别")]),s._v(" "),t("th",[s._v("效果")]),s._v(" "),t("th",[s._v("数据一致性")]),s._v(" "),t("th",[s._v("丢失更新")]),s._v(" "),t("th",[s._v("脏读")]),s._v(" "),t("th",[s._v("不可重复读")]),s._v(" "),t("th",[s._v("幻读")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("读未提交(Read uncommitted)")]),s._v(" "),t("td",[s._v("所有事务都可以看到其他未提交事务的执行结果")]),s._v(" "),t("td",[s._v("最低级别，只能保证不读取物理上损坏的数据")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("√")]),s._v(" "),t("td",[s._v("√")]),s._v(" "),t("td",[s._v("√")])]),s._v(" "),t("tr",[t("td",[s._v("读已提交(Read committed)")]),s._v(" "),t("td",[s._v("一个事务只能看见已经提交的事务所做的改变。可避免脏读的发生")]),s._v(" "),t("td",[s._v("语句级")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("√")]),s._v(" "),t("td",[s._v("√")])]),s._v(" "),t("tr",[t("td",[s._v("可重复读(Repeatable read)（默认）")]),s._v(" "),t("td",[s._v("确保同一事务的多个实例在并发读取数据时，会看到同样的数据行，解决了不可重复读的问题")]),s._v(" "),t("td",[s._v("事务级")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("√")])]),s._v(" "),t("tr",[t("td",[s._v("可序列化(Serializable)")]),s._v(" "),t("td",[s._v("通过强制事务排序，使得事务不可能相互冲突，从而解决幻读问题")]),s._v(" "),t("td",[s._v("最高级别，事务级")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("×")]),s._v(" "),t("td",[s._v("×")])])])]),s._v(" "),t("p",[t("mark",[s._v("备注 ： √  代表可能出现 ， × 代表不会出现 。")])]),s._v(" "),t("p",[s._v("Mysql 的数据库的默认隔离级别为 Repeatable read ， 查看方式：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" variables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'tx_isolation'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856535.png",alt:"1554331600009"}})]),s._v(" "),t("h3",{attrs:{id:"innodb-的行锁模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#innodb-的行锁模式"}},[s._v("#")]),s._v(" InnoDB 的行锁模式")]),s._v(" "),t("p",[s._v("InnoDB  实现了以下两种类型的行锁。")]),s._v(" "),t("ul",[t("li",[s._v("共享锁（S）：又称为读锁，简称 "),t("code",[s._v("S")]),s._v(" 锁，共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改。")]),s._v(" "),t("li",[s._v("排他锁（X）：又称为写锁，简称 "),t("code",[s._v("X")]),s._v(" 锁，排他锁就是不能与其他锁并存，如一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据就行读取和修改。")])]),s._v(" "),t("p",[s._v("对于 UPDATE、DELETE、INSERT 语句，InnoDB 会自动给涉及数据集加 排他锁（X)")]),s._v(" "),t("p",[s._v("对于普通SELECT语句，InnoDB不会加任何锁；")]),s._v(" "),t("p",[s._v("可以通过以下语句显示给记录集加共享锁或排他锁 。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 共享锁（S）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" table_name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHARE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MODE")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 排他锁（X)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" table_name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"行锁基本演示"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#行锁基本演示"}},[s._v("#")]),s._v(" 行锁基本演示")]),s._v(" "),t("p",[s._v("准备 sql")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test_innodb_lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\tid "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tname "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tsex "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("innodb")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("charset")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'100'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'400'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'500'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'600'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'700'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'800'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'900'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'200'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" idx_test_innodb_lock_id "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" test_innodb_lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" idx_test_innodb_lock_name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" test_innodb_lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("开启两个会话")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("Session-1")]),s._v(" "),t("th",[s._v("Session-2")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856867.png",alt:"1554354615030"}}),s._v("关闭自动提交功能")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856025.png",alt:"1554354601867"}}),s._v("关闭自动提交功能")])]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856060.png",alt:"1554354713628"}}),s._v("可以正常的查询出全部的数据")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856143.png",alt:"1554354717336"}}),s._v("可以正常的查询出全部的数据")])]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856133.png",alt:"1554354830589"}}),s._v("查询id 为3的数据 ；")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011856716.png",alt:"1554354832708"}}),s._v("获取id为3的数据 ；")])]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857899.png",alt:"1554382789984"}}),s._v("更新id为3的数据，但是不提交；")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857398.png",alt:"1554382905352"}}),s._v(" 更新id为3 的数据， 出于等待状态")])]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857874.png",alt:"1554382977653"}}),s._v("通过commit， 提交事务")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857720.png",alt:"1554383044542"}}),s._v(" 解除阻塞，更新正常进行")])]),s._v(" "),t("tr",[t("td",[s._v("以上， 操作的都是同一行的数据，接下来，演示不同行的数据 ：")]),s._v(" "),t("td")]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857339.png",alt:"1554385220580"}}),s._v(" 更新id为3数据，正常的获取到行锁 ，执行更新")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857040.png",alt:"1554385236768"}}),s._v(" 由于与 Session-1 操作不是同一行，获取当前行锁，执行更新；")])])])]),s._v(" "),t("h3",{attrs:{id:"无索引行锁升级为表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#无索引行锁升级为表锁"}},[s._v("#")]),s._v(" 无索引行锁升级为表锁")]),s._v(" "),t("p",[s._v("如果不通过索引条件检索数据，那么InnoDB将对表中的所有记录加锁，实际效果跟表锁一样。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--查看当前表的索引 ：")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" test_innodb_lock "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857273.png",alt:"1554385956215"}})]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("Session-1")]),s._v(" "),t("th",[s._v("Session-2")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857928.png",alt:"1554386287454"}}),s._v("关闭事务的自动提交")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857118.png",alt:"1554386312524"}}),s._v("关闭事务的自动提交")])]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857401.png",alt:"1554386654793"}}),s._v("执行更新语句")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857636.png",alt:"1554386685610"}}),s._v("执行更新语句， 但处于阻塞状态")])]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857697.png",alt:"1554386721653"}}),s._v("提交事务")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202302261229416.png",alt:"1554386750004"}}),s._v("解除阻塞，执行更新成功")])]),s._v(" "),t("tr",[t("td"),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857892.png",alt:"1554386804807"}}),s._v("执行提交操作")])])])]),s._v(" "),t("p",[t("code",[s._v("由于执行更新时，name字段本来为varchar类型， 我们是作为数字类型使用，存在类型转换，索引失效，最终行锁变为表锁 ；")])]),s._v(" "),t("h3",{attrs:{id:"间隙锁危害"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#间隙锁危害"}},[s._v("#")]),s._v(" 间隙锁危害")]),s._v(" "),t("p",[s._v('当我们用范围条件，而不是使用相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据进行加锁； 对于键值在条件范围内但并不存在的记录，叫做 "间隙（GAP）" ， InnoDB也会对这个 "间隙" 加锁，这种锁机制就是所谓的 间隙锁（Next-Key锁）。')]),s._v(" "),t("p",[s._v("示例 ：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("Session-1")]),s._v(" "),t("th",[s._v("Session-2")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857732.png",alt:"1554387987130"}}),s._v("  关闭事务自动提交 !")]),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857910.png",alt:""}}),s._v("      关闭事务自动提交")])]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857191.png",alt:"1554388492478"}}),s._v("根据id范围更新数据(id<4)")]),s._v(" "),t("td")]),s._v(" "),t("tr",[t("td"),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857925.png",alt:"1554388515936"}}),s._v("插入id为2的记录，处于阻塞状态!(因为id<4的数据不管存不存在都被锁掉了)")])]),s._v(" "),t("tr",[t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857846.png",alt:"1554388149305"}}),s._v("提交事务")]),s._v(" "),t("td")]),s._v(" "),t("tr",[t("td"),s._v(" "),t("td",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857432.png",alt:"1554388548562"}}),s._v("解除阻塞 ， 执行插入操作")])]),s._v(" "),t("tr",[t("td"),s._v(" "),t("td",[s._v("提交事务")])])])]),s._v(" "),t("h3",{attrs:{id:"innodb-行锁争用情况"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#innodb-行锁争用情况"}},[s._v("#")]),s._v(" InnoDB 行锁争用情况")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'innodb_row_lock%'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://images.zaiolos.top/images/202203011857223.png",alt:"1556455943670"}})]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Innodb_row_lock_current_waits")]),s._v(" "),t("p",[s._v("当前正在等待锁定的数量")])]),s._v(" "),t("li",[t("p",[s._v("Innodb_row_lock_time")]),s._v(" "),t("p",[s._v("从系统启动到现在锁定总时间长度")])]),s._v(" "),t("li",[t("p",[s._v("Innodb_row_lock_time_avg")]),s._v(" "),t("p",[s._v("每次等待所花平均时长")])]),s._v(" "),t("li",[t("p",[s._v("Innodb_row_lock_time_max")]),s._v(" "),t("p",[s._v("从系统启动到现在等待最长的一次所花的时间")])]),s._v(" "),t("li",[t("p",[s._v("Innodb_row_lock_waits")]),s._v(" "),t("p",[s._v("系统启动后到现在总共等待的次数")])])]),s._v(" "),t("p",[s._v("当等待的次数很高，而且每次等待的时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化计划。")]),s._v(" "),t("h3",{attrs:{id:"总结-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结-3"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("InnoDB存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面带来了性能损耗可能比表锁会更高一些，但是在整体并发处理能力方面要远远由于MyISAM的表锁的。当系统并发量较高的时候，InnoDB的整体性能和MyISAM相比就会有比较明显的优势。")]),s._v(" "),t("p",[s._v("但是，InnoDB的行级锁同样也有其脆弱的一面，当我们使用不当的时候，可能会让InnoDB的整体性能表现不仅不能比MyISAM高，甚至可能会更差。")]),s._v(" "),t("p",[s._v("优化建议：")]),s._v(" "),t("ul",[t("li",[s._v("尽可能让所有数据检索都能通过索引来完成，避免无索引行锁升级为表锁。")]),s._v(" "),t("li",[s._v("合理设计索引，尽量缩小锁的范围")]),s._v(" "),t("li",[s._v("尽可能减少索引条件，及索引范围，避免间隙锁")]),s._v(" "),t("li",[s._v("尽量控制事务大小，减少锁定资源量和时间长度")]),s._v(" "),t("li",[s._v("尽可使用低级别事务隔离（但是需要业务层面满足需求）")])])])}),[],!1,null,null,null);t.default=e.exports}}]);