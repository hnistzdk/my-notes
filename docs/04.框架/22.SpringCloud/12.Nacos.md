---
title: Nacos
date: 2022-11-15 16:36:56
permalink: /SpringCloud/Nacos/
categories:
  - 框架
  - SpringCloud
  - SpringCloud Alibaba
tags:
  - Nacos
  - SpringCloud Alibaba
---
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Nacos](#nacos)
  - [Nacos简介](#nacos%E7%AE%80%E4%BB%8B)
    - [为什么叫Nacos](#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%ABnacos)
    - [是什么](#%E6%98%AF%E4%BB%80%E4%B9%88)
    - [能干嘛](#%E8%83%BD%E5%B9%B2%E5%98%9B)
  - [安装并运行Nacos](#%E5%AE%89%E8%A3%85%E5%B9%B6%E8%BF%90%E8%A1%8Cnacos)
  - [Nacos作为服务注册中心演示](#nacos%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA)
    - [服务提供者](#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85)
      - [pom](#pom)
      - [yaml](#yaml)
      - [主启动类](#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB)
      - [Controller](#controller)
    - [服务消费者](#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85)
      - [pom](#pom-1)
      - [yaml](#yaml-1)
      - [业务类](#%E4%B8%9A%E5%8A%A1%E7%B1%BB)
    - [测试](#%E6%B5%8B%E8%AF%95)
    - [注册中心对比](#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AF%B9%E6%AF%94)
    - [AP、CP切换](#apcp%E5%88%87%E6%8D%A2)
  - [Nacos作为服务配置中心演示](#nacos%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA)
  - [Nacos集群和持久化配置(重要)](#nacos%E9%9B%86%E7%BE%A4%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE%E9%87%8D%E8%A6%81)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

---

# Nacos

```xml
<dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>2021.1</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
```

> 首先需要引入spring-cloud-alibaba-dependencies依赖管理



<Badge text="Nacos 服务注册与配置中心" type="error"/>



## Nacos简介

### 为什么叫Nacos

> 前四个字母分别为Naming和Configuration的前两个字母，最后的s为Service

### 是什么

- 一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台
- Nacos：Dynamic Naming and Configuration Service，即注册中心与配置中心的组合

### 能干嘛

- 替代Eureka作为注册中心
- 替代Config作为配置中心

![image-20221115171832488](https://images.zaiolos.top/images/202211151718636.png)



## 安装并运行Nacos

- 从GitHub下载nacos-server-2.1.2.zip，(.tar.gz是Linux的)
- 压解安装包，直接运行bin目录下的startup.cmd
- 命令运行成功后直接访问：http://localhost:8848/nacos

这里要注意，运行时需要增加命令参数`-m standalone`，否则运行失败

```bash
startup.cmd -m standalone # 单机模式启动 因为默认是集群模式
```

![image-20221115173526865](https://images.zaiolos.top/images/202211151735954.png)

## Nacos作为服务注册中心演示

### 服务提供者

> 新建cloudalibaba-provider-payment9001模块

#### pom

> 前面的父pom中要加cloud alibaba的父依赖，这里子pom相较以前，删除eureka的依赖，增加nacos的依赖

```xml
<dependencies>
        <!--        通用的依赖-->
        <dependency>
            <groupId>com.zdk</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>${project.version}</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- nacos依赖 -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
    </dependencies>
```

#### yaml

> yaml主要就是配置nacos注册中心地址和actuator监控管理

```yaml
server:
  port: 9001
  
spring:
  application:
    name: nacos-payment-provider
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
          
management:
  endpoints:
    web:
      exposure:
        include: '*'         
```

#### 主启动类

```java
@EnableDiscoveryClient
@SpringBootApplication
public class PaymentMain9001{
    public static void main(String[] args){
        SpringApplication.run(PaymentMain9001.class,args);
    }
}
```

#### Controller

```java
@RestController
public class PaymentController {

    @Value("${server.port}")
    private String serverPort;

    @GetMapping(value = "/payment/nacos/{id}")
    public String getPayment(@PathVariable("id") Integer id){
        return "nacos registry, serverPort："+serverPort+"\t id："+id;
    }
}
```

> 最后启动此9001服务，可以在nacos控制台中查看到服务注册情况

![image-20221115175037508](https://images.zaiolos.top/images/202211151750578.png)



> 最后，为了演示后面的nacos负载均衡功能，参照9001再建一个9002模块，步骤不再赘述，启动后可以发现nacos控制台`nacos-payment-provider`服务实例数量已变为2

![image-20221115175848839](https://images.zaiolos.top/images/202211151758907.png)

### 服务消费者

> 新建消费者模块cloudalibaba-consumer-nacos-order83

#### pom

> 将provider的pom复制过来，新增`spring-cloud-starter-loadbanlacer`的依赖
>
> 这里要注意，我是用的2021.0.4.0版本cloud alibaba的nacos-discovery包中，已经去除掉了loadbanlacer的依赖，所以不能再直接进行rest+服务名的调用，且不支持了负载均衡，所以这里要测试的话还需要再将loadbanlacer的包进行引入，**并且记得注入RestTemplate时加上`@LoadBalanced`注解**

```xml
<!-- nacos依赖 -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!-- loadbalancer依赖 -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

#### yaml

```yaml
server:
  port: 83

spring:
  application:
    name: nacos-order-consumer
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848

# 用来在代码中获取provider服务地址
service-url:
  nacos-user-service: http://nacos-payment-provider

```

> 主启动类不多赘述

因为这里使用到了ribbon，所以需要注入一个RestTemplate的Bean

```java
@Configuration
public class ApplicationContextConfig {
    @Bean
    @LoadBalanced //必须加这个注解 才能使用服务名走注册中心进行rest调用
    public RestTemplate restTemplate(){
        return new RestTemplate();
    }   
}
```

#### 业务类

```java
@RestController
public class OrderNacosController {
    @Resource
    private RestTemplate restTemplate;

    @Value("${service-url.nacos-user-service}")
    private String serviceUrl;


    @GetMapping(value = "/consumer/payment/nacos/{id}")
    public String paymentInfo(@PathVariable("id") Integer id){
        return restTemplate.getForObject(serviceUrl+"/payemnt/nacos/"+id, String.class);
    }
}
```

> 最后启动此消费者，nacos控制台出现它的信息即可

![image-20221115183213390](https://images.zaiolos.top/images/202211151832464.png)

### 测试

> 三个服务均启动好，访问http://localhost:83/consumer/payment/nacos/1
>
> 我们可以发现对于两个provider，是轮询访问

> 这里其实就是引入一个负载均衡来测试注册中心，2021.1版本的nacos本身已不带有负载均衡



### 注册中心对比

> nacos支持CP、AP模型的切换

![image-20221115185730171](https://images.zaiolos.top/images/202211151857285.png)



nacos与其他注册中心特性对比

|                  | Nacos                      | Eureka      | Consul            | CoreDNS | Zookeeper   |
| ---------------- | -------------------------- | ----------- | ----------------- | ------- | ----------- |
| 一致性协议       | CP、AP均可                 | AP          | CP                | /       | CP          |
| 健康检查         | TCP/HTTP/MYSQL/Client Beat | Client Beat | TCP/HTTP/gRPC/Cmd | /       | Client Beat |
| 负载均衡         | 权重/DSL/metadata/CMDB     | Ribbon      | Fabio             | RR      | /           |
| 雪崩保护         | 支持                       | 支持        | 不支持            | 不支持  | 不支持      |
| 自动注销实例     | 支持                       | 支持        | 不支持            | 不支持  | 支持        |
| 访问协议         | HTTP/DNS/UDP               | HTTP        | HTTP/DNS          | DNS     | TCP         |
| 监听支持         | 支持                       | 支持        | 支持              | 不支持  | 支持        |
| 多数据中心       | 支持                       | 支持        | 支持              | 不支持  | 不支持      |
| 跨注册中心       | 支持                       | 不支持      | 支持              | 不支持  | 不支持      |
| Spring Cloud集成 | 支持                       | 支持        | 支持              | 不支持  | 不支持      |
| Dubbo集成        | 支持                       | 不支持      | 不支持            | 不支持  | 支持        |
| K8S集成          | 支持                       | 不支持      | 支持              | 支持    | 不支持      |

### AP、CP切换

**C是所有节点在同一时间看到的数据是一致的;而A的定义是所有的请求都会收到响应。**



::: tip 何时选择使用何种模式？

一般来说，

<br/>

如果不需要存储服务级别的信息且服务实例是通过racos-client注册，并能够保持心跳上报，那么就可以选择AP模式。当前主流的服务如Spring Cloud和Dubbo 服务，都适用于AP模式，AP模式为了服务的可能性而减弱了一致性，因此AP模式下只支持注册临时实例。

<br/>

如果需要在服务级别编辑或者存储配置信息，那么CP是必须，K8S服务和DNS服务则适用于CP模式。

<br/>

CP模式下则支持注册持久化实例，此时则是以Raft协议为集群运行模式，该模式下注册实例之前必须先注册服务，如果服务不存在，则会返回错误。

:::

可以通过下面的命令修改模式

```bash
curl -X PUT '$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&value=CP'
```



## Nacos作为服务配置中心演示



## Nacos集群和持久化配置(重要)
